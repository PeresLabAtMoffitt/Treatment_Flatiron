---
title: "Flatiron cleaning"
author: "Christelle Colin-Leitzinger"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: flatly
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
.figure {
   margin-top: 25px;
   margin-bottom: 100px;
}

table {
    margin-top: 1px;
    margin-bottom: 25px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      fig.align='center'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```
<br>

***

```{r library, include=FALSE}
library(drake)
library(tidyverse)
library(data.table)
library(lubridate)
library(ggplot2)
library(gtsummary)
library(survminer)
library(survival)
library(mice)
```

```{r loadd}
loadd(drugs)
creatinine <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/creatinine.rds")
weight <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/weight.rds")
height <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/height.rds")
body_surface_area <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/body_surface_area.rds")
areaUC <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/areaUC.rds")
clinical_data <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/clinical_data.rds")
```


# `r emo::ji("spiral_notepad")` This report is using **actual weight**  

***

# `r emo::ji("spiral_notepad")` Reminders of each capping and formula:  

Creatinine data are capped as :  
- creat < 0.7 was set at 0.7  
- creat > 3 are eliminated  

CrCl calculation :

$$CrCl = \frac{(140 - ageatdx) * weight\_closest\_to\_cycle}{72 * creatinine\_closest\_to\_cycle} * 0.85$$
and is capped at 125.  
<br>


Calculating more BSA values :
$$bsa\_du\_bois = 0.007184 * (height*100)^{0.725} * weight^{0.425}$$
<br>

I clean the data up by keeping the `relativeorderedamount`:  
- >= 50 & <= 175 for taxel and cisplatin  and with a unit in `mg/m2`  
- >= 2  & <= 6   for platin and with a unit in `AUC`

<br>

`expected_dose` is:  
-`target_auc` * (`CrCl` + 25)   -> for `drugname` == "carboplatin"  
-`BSA` * `target_auc`           -> for `drugname` == "taxel" or "cisplatin"  
(Again keep in mind that `target_auc` is just the name of the column in the data but is calculated differently depending of the drug name)  
It was capped to 900 when was > 900 for a `target_auc` of 6 and to 750 when was > 750 for a `target_auc` of 5 (Carboplatin). 

<br>

Then I calculate $$relative\_dose\_intensity = \frac{amount}{expected\_dose}$$

<br>

<span style="color:red">**Please confirm everything is correct**</span>  

***

# I. Drug episode cleaning

- Select episodedatasource == "Administrations"

**We have `r clinical_data %>% distinct(patientid) %>% nrow()` patients info in clinical data.  
**We have `r drugs %>% distinct(patientid) %>% nrow()` patients info in clinical data.  

```{r drugs episode cleanup}
drugs <- drugs %>% 
  # Select only records for administration
  filter(episodedatasource == "Administrations") %>%
  # bind with clinical
  inner_join(., clinical_data, 
          by = "patientid") %>% 
  arrange(patientid, episodedate)
```
But when merged both data, we have `r drugs %>% distinct(patientid) %>% nrow()` patients with clinical informations who received drugs.

- Combine multiple administrations of the same drug at the same date
Flatiron says:
There are a small number of patients with multiple records in the MedicationAdministration table for the same drug on the same day. We reviewed several instances where this occurs in the original EMR records and found, in each case, legitimate clinical reasons substantiating the multiple administrations per day. Although these instances were legitimate medication administrations, Flatiron Health data are generated from real-world clinical practice and are subject to miscoding and errors by the clinical oncology team, as are all EMR data. Below are three patient vignettes taken from our review of EMR notes, illustrating the variety of reasons why this may occur.  
For clinical reasons, a patient was given higher than normal dose which was listed as two administrations of the normal dose.  
Three administrations of the same drug were listed on a Friday. The EMR note stated that one dose was administered in the office and the patient was sent home with the two remaining doses for the weekend.   
Patient had an allergic reaction in the past and was administered multiple smaller doses in the same day as part of a desensitization protocol.
```{r combine amount same drug one day}
combined_drugs <- drugs %>% 
  # Combined Multiple Administrations----
  # combined multiple amount of drug given the same day FCF86329BB40C F4E6EE1910940.May be 205 patients row like that
  group_by(patientid, linename, linenumber, linestartdate, lineenddate, episodedate,
           drugname, units, ismaintenancetherapy) %>%
  summarise_at(vars(route, amount), paste, collapse = ";") %>% # keep them in the data then do sum
  mutate(route = case_when(
    str_detect(route, ";")            ~ "Intravenous", # I checked that all the combined administration are IV
    TRUE                              ~ route
  )) %>% 
  separate(col= amount, paste("amount_", 1:10, sep=""), sep = ";", extra = "warn",
           fill = "right") %>%
  ungroup() %>% 
  mutate(across(starts_with("amount"), ~ na_if(., "NA"))) %>% 
  purrr::keep(~!all(is.na(.))) %>%
  mutate(across(starts_with("amount"), ~ as.numeric(.))) %>% 
  mutate(amount = rowSums(select(.,starts_with("amount_")), na.rm = TRUE)) %>%
  # Found ug, ml, Ea, and NA they are all good, but 
  # ug need conversion
  # the AUC are mostly correct (real mg) but are actual AUC when < at 10 so remove
  mutate(amount =  case_when(
    units == "ug"               ~ amount / 10, # I checked all of them
    units == "AUC" &
      amount < 10               ~ NA_real_,
    TRUE                        ~ amount
  ))# %>% 
  
  # mutate(drugname_type = case_when(
  #   str_detect(drugname, "platin")       ~ "platin",
  #   str_detect(drugname, "taxel")        ~ "taxel"
  # ))
```

- Recode linenumber depending on surgery date (Categorize Neo and Adjuavnt)
```{r line coding}
therapy_line <- combined_drugs %>% 
  # bind again with clinical - was lost while summarizing
  inner_join(., clinical_data, 
          by = "patientid") %>% 
  arrange(patientid, episodedate) %>% 
  # Define Adjuvant, Neoadjuvant, chemo or surgery
  mutate(chemotherapy_type = case_when(
    # ismaintenancetherapy == "TRUE"    ~ "maintenance",
    episodedate <= surgerydate        ~ "Neoadjuvant", # F63ABD6AEB12C, F4F7B1C5DF24F intraperitoneal Carboplatin
    episodedate > surgerydate         ~ "Adjuvant",
    is.na(surgerydate) &
      !is.na(episodedate)             ~ "Chemotherapy only",
    !is.na(surgerydate) &
      is.na(episodedate)              ~ "Surgery only"
    )) %>% 
  mutate(chemotherapy_type = 
           factor(chemotherapy_type, levels = 
                    c("Neoadjuvant", "Adjuvant", "Chemotherapy only", "Surgery only"))) %>%
  group_by(patientid) %>% 
  mutate(had_neo = ifelse(str_detect(chemotherapy_type, "Neo"), "Yes", NA_character_)) %>% 
  mutate(had_adj = ifelse(str_detect(chemotherapy_type, "Adj"), "Yes", NA_character_)) %>% 
  fill(had_neo, had_adj, .direction = "updown") %>% 
  mutate(treatment_sequence = case_when(
    had_neo == "Yes" &
      had_adj == "Yes"                           ~ "neo + surg + adj",
    had_neo == "Yes" &
      is.na(had_adj)                             ~ "neo + surg",
    is.na(had_neo) &
      had_adj == "Yes"                           ~ "surg + adj",
    chemotherapy_type == "Chemotherapy only"     ~ "Chemotherapy only",
    chemotherapy_type == "Surgery only"          ~ "Surgery only"
  )) %>% 
  mutate(therapy = case_when(
    chemotherapy_type == "Neoadjuvant"           ~ "Upfront Chemo",
    chemotherapy_type == "Chemotherapy only"     ~ "Chemotherapy only",
    chemotherapy_type == "Surgery only"          ~ "Surgery only",
    is.na(had_neo) &
      had_adj == "Yes"                           ~ "Upfront Surgery"
  )) %>% 
  fill(therapy, .direction = "downup") %>% 
  
  # Redefine line number based on the original linenumber variable and the surgery date
  mutate(linenumber_n = dense_rank(interaction(linenumber, chemotherapy_type))) %>%  
  # Redefine line number based on the new linenumber variable and if a switch 
  # to maintenance is detected within the line
  group_by(patientid, linenumber_n, ismaintenancetherapy) %>% 
  mutate(maint_rank = row_number(ismaintenancetherapy),
         maint_rank = ifelse(maint_rank == 1, 1, 0)) %>% 
  group_by(patientid) %>% 
  mutate(linenumber_new = cumsum(maint_rank)) %>%  
  # F0000AD999ABF, F1C68CFAC2AF3, FBCF69031DFF8, F0040EA299CF0, FAACDC7205803,  FA019D2071321 no has big jump F95D860690A93 F0F1324B863A8
  select(patientid, linename, linenumber, linenumber_new, drugname, 
         episodedate, surgerydate, chemotherapy_type, everything()) %>% 
  ungroup() %>% 
  # Define line number restarting to 1 for each chemotherapy_type
  group_by(patientid, chemotherapy_type) %>% 
  mutate(linenumber_adj = dense_rank(linenumber_new)) %>% 
  ungroup() %>% 
  mutate(across(c("linenumber", "linenumber_new", "linenumber_adj"), as.factor)) %>% 
  # Redefine line dates
  group_by(patientid, linenumber_new) %>% 
  mutate(linestartdate = min(episodedate)) %>% 
  mutate(lineenddate = max(episodedate)) %>% 
  ungroup() %>% 
  select(-c(linenumber_n, maint_rank))
  
  # 6.Add a 30 day rule to switch linenumber----
  # group_by(patientid, linenumber_new) %>% 
  # arrange(episodedate) %>% 
  # mutate(episode_interval = episodedate - lag(episodedate), episode_interval = ifelse(is.na(episode_interval), 0, episode_interval)) %>%  # FDB58481AFFBB 48 days
  # mutate(jump_line = ifelse(episode_interval > 31, 1, 0)) %>% # FA019D2071321 >31
  # ungroup() %>% 
  # group_by(patientid) %>% 
  # mutate(jump_line = cumsum(jump_line)) %>% # F002DD2953889 fixed even when increase multiple time 
  # mutate(linenumber_new = linenumber_new + jump_line) %>% 
  #F002DD2953889 need to do 37 and 42 F0040EA299CF0, 35 F005602DA4DF0 => do at least 37
  
```

```{r cycle coding}
therapy_cycle <- therapy_line %>% 
  # Define cycle for each line
  # F003F2BEEDB37 need to change drugname pacli = pacli bp
  mutate(cycle_drugname = str_remove(drugname, " protein-bound")) %>%  
  # Need the number of time of the "major" drug is seen in the line
  group_by(patientid, linenumber_new, cycle_drugname) %>%
  mutate(drugname_count_perline = case_when(
           str_detect(drugname, "carboplatin|paclitaxel")     ~ n()
         )) %>%
  ungroup() %>% 
  arrange(patientid, episodedate, drugname) %>% 
  group_by(patientid, linenumber_new) %>%
  # Take the major drugname as a mark of new cycle start
  mutate(cycle_count_perline = min(drugname_count_perline, na.rm = TRUE)) %>%
  mutate(cycle_major_drugname = case_when(
    cycle_count_perline == drugname_count_perline &
      (cycle_drugname == "carboplatin" |
      cycle_drugname == "paclitaxel")                      ~ cycle_drugname,
    TRUE                                                   ~ NA_character_
  )) %>% 
  # select(-drugname_count_perline) %>% 
  # Code cycle number based on when major drug name appear again
  group_by(patientid, linenumber_new, drugname, cycle_major_drugname) %>%
  mutate(cycle_increment = row_number(cycle_major_drugname)) %>% # Look at F002DD2953889 inversed dose dense------------------
  # F01D908A013B7 weird dose dense

  # F003F2BEEDB37 change of dose dense 50% ok? ---------------------------------------------------------------
  
  arrange(patientid, episodedate, cycle_increment) %>% 
  group_by(patientid, linenumber_new) %>%
  fill(cycle_increment, .direction = "downup") %>%  # make sure I can do up for have one new drug compare to the linename FBB5186A15CD9 ok, FE593EDF5586A has a switched drugs will be removed
  group_by(patientid, chemotherapy_type, cycle_increment) %>% 
  # Code is_dose_dense to be 1 for the first drug in the cycle
  mutate(is_dose_dense = row_number(cycle_increment),
         is_dose_dense = ifelse(is_dose_dense == 1, 1, NA_real_)) %>% 
  group_by(patientid) %>% 
  mutate(total_cycle_increment = row_number(is_dose_dense)
         ) %>% 
  group_by(patientid, linenumber_adj) %>% 
  fill(total_cycle_increment, .direction = "downup") %>% 
  # cycle date
  group_by(patientid, linenumber_new, cycle_increment) %>% 
  mutate(cycle_start_date = min(episodedate)) %>% 
  
  # Look at dose dense
  # Code how many time a drug comes up in a cycle
  group_by(patientid, linenumber_new, cycle_increment, cycle_drugname) %>%  # weird dose dense F064D9EB733B3 F050B815FC126
  mutate(dose_dense = n()) %>% 
  mutate(dose_dense = max(dose_dense)) %>%  # too much cycle
  ungroup()

  # # CODE FOR SKIPPED CYCLE
  # group_by(patientid, linenumber_new) %>% 
  # mutate(cycle_interval = cycle_start_date - lag(cycle_start_date), 
  #        cycle_interval = ifelse(cycle_interval == 0, NA_real_, cycle_interval)) %>%  # FDB58481AFFBB 48 days
  # 
  # # take for granted that the cycle interval days are the routine cycle for the rest of the line FAACDC7205803
  # mutate(n = row_number(drugname)) %>%
  # 
  # mutate(base_days_between_cycle = ifelse(n==2 , cycle_interval, NA_real_)) %>%
  # fill(base_days_between_cycle, .direction = "downup") %>% 
  # mutate(skipped_cycle_indays = ifelse(((cycle_interval - base_days_between_cycle) != 0) ,
  #                                      (cycle_interval - base_days_between_cycle), NA_real_)) %>% # weird FDB58481AFFBB
  # # Fix skipped_cycle_indays when only 1 drug FDB58481AFFBB skipped_cycle_indays = NA, no other choice...
  # group_by(patientid, linenumber_new) %>%
  # mutate(drug_count_perline = n()) %>%
  # mutate(skipped_cycle_indays1 = ifelse(
  #   (cycle_count_perline == drug_count_perline), NA_real_, skipped_cycle_indays 
  # )) %>% # F001443D8B85C Pb with when different pattern by cycle => May not be able to have the skipped cycle
  # # or need to compare with dose like if 100 should be 7 days and if 200 should be 14 days....
  # group_by(patientid) %>% 
  # mutate(mean_skipped_cycle_indays = mean(skipped_cycle_indays, na.rm = TRUE)) %>% 
  # ungroup()

# rm(drugs, drugs1, therapy_line)
therapy_cycle %>% distinct(patientid) %>% nrow()
```

<br>

- Bind everything together to calculate target auc/target dose and expected dose

(hold on to the thought that what I call `target_auc` include the target AUC calculated for Carboplatin and target dose calculated for cisplatin and paclitaxel, they are just present in the same column called `target_auc` for a tidy data organisation - You can find the calculations formula at the end of the document)  
When I bind the data together (drug + corresponding creatinine + ...), I take the closest date of creatinine, height, weight, BSA, AUC, from the cycle date to calculate `target_auc` for Carboplatin, and paclitaxel and their `expected_dose`. It can be days in between but it can also be more. 

`r emo::ji("check")`  
We decided to take the creatinine, weight, bsa measured within a month of the cycle start date AND before surgery when Neoadjuvant line, after surgery but before end of line when Adjuvant line

```{r target_auc and expected dose}
Treatment1 <- 
  # Merge with creatinine
  left_join(therapy_cycle, creatinine, by = "patientid") %>%
  mutate(interval_creat = abs(interval(start= creat_date, end= cycle_start_date)/                      
                          duration(n=1, unit="days"))) %>% 
  mutate(interval_creat = case_when(
    (therapy == "Upfront Surgery" &
       interval_creat < 31 &
       # creat_date < lineenddate &
       creat_date > surgerydate)                  ~ interval_creat,
    
    therapy == "Upfront Chemo" &
      (
        (chemotherapy_type == "Neoadjuvant" &
           interval_creat < 31 &
           creat_date < surgerydate) |
          (chemotherapy_type == "Adjuvant" &
             interval_creat < 31 &
             # creat_date < lineenddate &
             creat_date > surgerydate)
      )                                          ~ interval_creat,
    TRUE                                         ~ NA_real_
  )) %>%
  arrange(interval_creat) %>% 
  distinct(patientid, episodedate, drugname, amount, linenumber_new, cycle_count_perline, cycle_increment, 
           cycle_start_date, .keep_all = TRUE) %>% 
  
  # Merge with height
  left_join(. , height,  by = "patientid") %>%
  mutate(interval_height = abs(interval(start= height_date, end= cycle_start_date)/
           duration(n=1, unit="days"))) %>%
  arrange(interval_height) %>%
  distinct(patientid, episodedate, drugname, amount, linenumber_new, cycle_count_perline, cycle_increment,
           cycle_start_date, .keep_all = TRUE) %>%
  
  # Merge with weight
  left_join(. , weight, by = "patientid") %>%
  mutate(interval_weight = abs(interval(start= weight_date, end= cycle_start_date)/
                        duration(n=1, unit="days"))) %>%
  mutate(interval_weight = case_when(
    (therapy == "Upfront Surgery" &
       interval_weight < 31 &
       # weight_date < lineenddate &
       weight_date > surgerydate)                  ~ interval_weight,
    
    therapy == "Upfront Chemo" &
      (
        (chemotherapy_type == "Neoadjuvant" &
           interval_weight < 31 &
           weight_date < surgerydate) |
          (chemotherapy_type == "Adjuvant" &
             interval_weight < 31 &
             # weight_date < lineenddate &
             weight_date > surgerydate)
      )                                          ~ interval_weight,
    TRUE                                         ~ NA_real_
  )) %>%
  arrange(interval_weight) %>%
  distinct(patientid, episodedate, drugname, amount, linenumber_new, cycle_count_perline, cycle_increment,
         cycle_start_date, .keep_all = TRUE) %>%

  # Calculate ideal dody weight
  mutate(ideal_weight = case_when(
    height <= 1.524               ~ 45.5 + 2.3,
    height > 1.524                ~ 45.5 + (2.3 * (((height - 1.524) / 0.0254)))
  )) %>% 
  mutate(adjusted_weight = ((weight - ideal_weight) * 0.40) + ideal_weight
  ) %>% 
  # Calculate bmi
  mutate(bmi_at_dx = weight_at_dx / (height_at_dx * height_at_dx)) %>%
  mutate(bmi_cat = case_when(
    bmi_at_dx < 25                    ~ "Underweight and normal weight",
    bmi_at_dx >= 25 &
      bmi_at_dx < 30                  ~ "Overweight",
    bmi_at_dx >= 30                   ~ "Obese"
  )) %>%
  mutate(bmi_cat = factor(bmi_cat, levels = c("Underweight and normal weight", "Overweight", "Obese"))) %>%
  
  mutate(actual_bmi = weight / (height * height)) %>%
  mutate(actual_bmi_cat = case_when(
    actual_bmi < 25                    ~ "Underweight and normal weight",
    actual_bmi >= 25 &
      actual_bmi < 30                  ~ "Overweight",
    actual_bmi >= 30                   ~ "Obese"
  )) %>%
  mutate(actual_bmi_cat = factor(actual_bmi_cat, 
                                  levels = c("Underweight and normal weight", "Overweight", "Obese"))) %>%
  # select(patientid, weight, height, bmi_at_dx, ideal_weight, adjusted_weight, adjusted_bmi)
  # Calculate CrCl
  # inner_join(., clinical_data %>% select(-surgerydate),
  #            by = "patientid") %>% 
  mutate(CrCl = (
       (
    ((140 - ageatdx) * weight) /
    (72 * creatinine)
       ) *
    0.85)
  ) %>% 
  mutate(CrCl = case_when(
    CrCl > 125                        ~ 125,
    TRUE                              ~ CrCl
  )) %>% 
  mutate(adjusted_CrCl = case_when(
    actual_bmi >= 25                  ~ CrCl,
    actual_bmi < 25                   ~ (((140 - ageatdx) * adjusted_weight) / (72 * creatinine)) * 0.85
  )) %>% 
  mutate(adjusted_CrCl = case_when(
    adjusted_CrCl > 125               ~ 125,
    TRUE                              ~ adjusted_CrCl
  )) %>% 

  # Merge with body_surface_area
  left_join(., body_surface_area, by = "patientid") %>%
  mutate(interval_bsa = abs(interval(start= bsa_date, end= cycle_start_date)/
                          duration(n=1, unit="days"))) %>%
  mutate(interval_bsa = case_when(
    (therapy == "Upfront Surgery" &
       interval_bsa < 31 &
       # bsa_date < lineenddate &
       bsa_date > surgerydate)                  ~ interval_bsa,
    
    therapy == "Upfront Chemo" &
      (
        (chemotherapy_type == "Neoadjuvant" &
           interval_bsa < 31 &
           bsa_date < surgerydate) |
          (chemotherapy_type == "Adjuvant" &
             interval_bsa < 31 &
             # bsa_date < lineenddate &
             bsa_date > surgerydate)
      )                                          ~ interval_bsa,
    TRUE                                         ~ NA_real_
  )) %>%
  arrange(interval_bsa) %>%
  distinct(patientid, episodedate, drugname, amount, linenumber_new, cycle_count_perline, cycle_increment,
           cycle_start_date, .keep_all = TRUE) %>%
  # Calculate more bsa value with height and weight using Du Bois formula
  mutate(bsa_du_bois = 0.007184 * ((height*100)^0.725) * (weight^0.425)) %>% # get pretty close results 4269 patients result
  mutate(BSA = coalesce(BSA, bsa_du_bois)) %>%
  mutate(bsa_du_bois = 0.007184 * ((height_at_dx*100)^0.725) * (weight_at_dx^0.425)) %>% # get pretty close results 4269 patients result
  mutate(bsa_at_dx = coalesce(bsa_at_dx, bsa_du_bois)) %>%
  select(-bsa_du_bois) %>%

  # Merge with auc
  left_join(., areaUC, by = c("patientid", "drugname")) %>%
  mutate(interval_auc = abs(interval(start= auc_date, end= cycle_start_date)/ # use episode date to be more precise? No it's not better
                          duration(n=1, unit="days"))) %>% 
  mutate(interval_auc = case_when(
    (therapy == "Upfront Surgery" &
       interval_auc < 31 &
       # auc_date < lineenddate &
       auc_date > surgerydate)                  ~ interval_auc,
    
    therapy == "Upfront Chemo" &
      (
        (chemotherapy_type == "Neoadjuvant" &
           interval_auc < 31 &
           auc_date < surgerydate) |
          (chemotherapy_type == "Adjuvant" &
             interval_auc < 31 &
             # auc_date < lineenddate &
             auc_date > surgerydate)
      )                                          ~ interval_auc,
    TRUE                                         ~ NA_real_
  )) %>%
  arrange(interval_auc) %>% 
  distinct(patientid, episodedate, drugname, amount, linenumber_new, cycle_count_perline, cycle_increment, 
           cycle_start_date, .keep_all = TRUE) %>% 

  # Calculate expected dose
  mutate(expected_dose = case_when(
    drugname == "carboplatin"                 ~ target_auc * (CrCl + 25),
    drugname == "paclitaxel"                  ~ BSA * target_auc 
    # F19EBBFC60652 Can we fill target_auc? No depends of the type of cycle, or maybe by grouping by cycle type and drug
  )) %>% 
  mutate(expected_dose = case_when(
    expected_dose > 900 &
      target_auc == 6              ~ 900,
    expected_dose > 750 &
      target_auc == 5              ~ 750,
    TRUE                           ~ expected_dose
  )) %>% 
  mutate(adjusted_expected_dose = case_when(
    drugname == "carboplatin"                 ~ target_auc * (adjusted_CrCl + 25),
    drugname == "paclitaxel"                  ~ BSA * target_auc 
    # F19EBBFC60652 Can we fill target_auc? No depends of the type of cycle, or maybe by grouping by cycle type and drug
  )) %>% 
  mutate(adjusted_expected_dose = case_when(
    adjusted_expected_dose > 900 &
      target_auc == 6              ~ 900,
    adjusted_expected_dose > 750 &
      target_auc == 5              ~ 750,
    TRUE                           ~ adjusted_expected_dose
  )) %>% 
  group_by(patientid) %>%
  mutate(first_treatment_date = case_when(
    str_detect(therapy, "Chemo")                      ~ min(episodedate),
    str_detect(therapy, "Surgery")                    ~ surgerydate,
  )) %>% 
  ungroup() %>% 
  mutate(month_at_os_from_treatment = interval(start = first_treatment_date, end = followupdate)/
                   duration(n=1, units = "months")) %>% 
  arrange(patientid, episodedate)

Treatment1 %>% distinct(patientid) %>% nrow()
```

```{r plot interval}
# Treatment %>% 
#   ggplot(aes(x= interval_creat)) +
#   geom_bar() #+
#   # coord_cartesian(ylim=c(0,50))
# # Treatment %>% 
# #   ggplot(aes(x= interval_height)) +
# #   geom_bar() +
# #   coord_cartesian(ylim=c(0,50))
# Treatment %>% 
#   ggplot(aes(x= interval_weight)) +
#   geom_bar() #+
#   # coord_cartesian(ylim=c(0,50))
# Treatment %>% 
#   ggplot(aes(x= interval_bsa)) +
#   geom_bar() #+
#   # coord_cartesian(ylim=c(0,50))
# Treatment %>% 
#   ggplot(aes(x= interval_auc)) +
#   geom_bar() #+
#   # coord_cartesian(ylim=c(0,50))
```

<!-- # Variable for filtering -->

```{r rule between diagnosis and treatment}
Treatment <- Treatment1 %>% 
  filter(route == "Intravenous") %>% 
  # step 1: Flatiron recommendation cleanup
  # 90 days rule between diagnosis and treatment
  group_by(patientid) %>% 
  mutate(first_drug_date = first(episodedate)) %>% 
  ungroup() %>% 
  mutate(days_at_first_drug = interval(start = diagnosisdate, end = first_drug_date)/
           duration(n=1, units = "days")) %>% 
  mutate(days_at_surg = interval(start = diagnosisdate, end = surgerydate)/
           duration(n=1, units = "days")) %>% 
  mutate(days_at_first_treatment = case_when(
    therapy == "Upfront Chemo" |
      therapy == "Chemotherapy only"             ~ interval(start = diagnosisdate, end = first_drug_date)/
           duration(n=1, units = "days"),
    therapy == "Upfront Surgery" |
      therapy == "Surgery Only"                  ~ interval(start = diagnosisdate, end = surgerydate)/
           duration(n=1, units = "days")
  )) %>% 
  # 30 days rule excluding patient who didn’t survive for at least 30 days after diagnosis
  mutate(thirty_days_exclusion = interval(start = diagnosisdate, end = dateofdeath)/
           duration(n=1, units = "days")
  ) %>% 
  mutate(flatiron_rules = case_when(
    days_at_first_treatment > 90                 ~ "exclude",
    thirty_days_exclusion <= 30                  ~ "exclude",
    exclude == "1"                               ~ "exclude"
  )) %>%
  group_by(patientid) %>% 
  fill(flatiron_rules, .direction = "downup") %>% 
  ungroup() %>% 
  
  # step 2: Filter patients with clinical characteristics fitting to the study criteria
  # include only patients who received platin and/or taxane
  mutate(had_carbo_pacli = case_when(
    drugname == "paclitaxel" |
      drugname == "carboplatin"             ~ "Yes"
  )) %>% 
  group_by(patientid) %>% 
  fill(had_carbo_pacli, .direction = "updown") %>% 
  ungroup() %>% 
  # include patients with single or dual P/T +/- Bev as frontline treatment
  mutate(line_keep = case_when(# F002B429BE6C6
    (linenumber_adj == 1 &
           (linename == "Carboplatin,Paclitaxel" |
           linename == "Bevacizumab,Carboplatin,Paclitaxel" |
           linename == "Carboplatin" |
           linename == "Paclitaxel" |
           linename == "Bevacizumab,Paclitaxel" |
           linename == "Bevacizumab,Carboplatin"))            ~ NA_character_,
    linenumber_adj == 1                                       ~ "exclude"
  )) %>% 
  group_by(patientid) %>%
  fill(line_keep, .direction = "updown") %>% 
  ungroup() %>% 
  
  # step 3: Filter out patients with missing data
  # remove patients with long gap between surgery and adjuvant start (3 months)
  mutate(interval_surgery_to_adj_start = case_when(
      chemotherapy_type == "Adjuvant" &
        linenumber_adj == 1       
      ~ interval(start = surgerydate, end = linestartdate) / duration(n = 1, units = "months")
    )) %>% 
  mutate(gap_surg_drugs = case_when(
    interval_surgery_to_adj_start > 3                  ~ "exclude"
  )) %>% 
  group_by(patientid) %>% 
  fill(gap_surg_drugs, .direction = "updown") %>% 
  ungroup() %>% 

  # step 4: Include patients with treatments following the standard of clinical care
  # exclude patients with more than 1 line as Neo
  mutate(neo_more_more_than_1line = case_when(
    chemotherapy_type == "Neoadjuvant" &
           linenumber_new != 1                 ~ "exclude"
  )) %>% 
  group_by(patientid) %>% 
  fill(neo_more_more_than_1line, .direction = "updown") %>% 
  ungroup() %>% 
  # exclude patients with maintenance within their frontline
  mutate(frontline_has_maintenance = case_when(
    linenumber_adj == 1 &
    ismaintenancetherapy == "TRUE"             ~ "exclude"
  )) %>% 
  group_by(patientid) %>% 
  fill(frontline_has_maintenance, .direction = "updown") %>% 
  ungroup() %>% 
  # exclude patients with more than 6 cycles in Neo, more than 9 cycles total 
  # in upfront chemo or more than 9 cycles in upfront surgery
  mutate(too_many_cycle = case_when(
    (linenumber_new == 1 &
       therapy == "Upfront Chemo" &
       total_cycle_increment > 6) |
      
      (linenumber_new == 2 &
         therapy == "Upfront Chemo" &
         total_cycle_increment > 9) |
      
      (linenumber_new == 1 &
         therapy == "Upfront Surgery" &
         total_cycle_increment > 9)             ~ "exclude"
  )) %>% 
  group_by(patientid) %>%
  fill(too_many_cycle, .direction = "updown") %>%
  ungroup() %>% 
  # Exclude patients that received wrong dose dense of 1 carbo + 2 paclitaxels
  # Removes also the patients who has only carbo or only pacli
  # dose_dense will need to be changed if we change and include these patients
  arrange(patientid, episodedate, drugname) %>% 
  mutate(wrong_pacli_dosedense = case_when(
    drugname == "paclitaxel" &
      is.na(too_many_cycle) &
      (dose_dense == 2 |
      dose_dense > 3) &
      linenumber_adj == 1
      # ((linenumber_new == 1 &
      #  therapy == "Upfront Chemo") |
      # (linenumber_new == 2 &
      #    therapy == "Upfront Chemo") |
      # (linenumber_new == 1 &
      #    therapy == "Upfront Surgery"))
    ~ "exclude"
  )) %>% 
  group_by(patientid) %>%
  fill(wrong_pacli_dosedense, .direction = "updown") %>% 
  ungroup() %>% 
  # Exclude patients who switch drug within a line
  mutate(switch_drugs = case_when(
    str_detect(linename, "Pacli") & 
      drugname == "docetaxel" & 
      linenumber_adj == 1                      ~ "exclude",
    str_detect(linename, "Car") & 
      drugname == "cisplatin" & 
      linenumber_adj == 1                      ~ "exclude"
  )) %>% 
  group_by(patientid) %>%
  fill(switch_drugs, .direction = "updown") %>% 
  ungroup()



  # group_by(patientid, wrong_pacli_dosedense) %>% 
  # mutate(n_dose_dense = n()) %>% 
  # 
  # 
  # 
  # is.na(too_many_cycle)
  
  
Treatment %>% distinct(patientid) %>% nrow()
```

```{r RDI calculation}
Treatment <- Treatment %>% 
  # filter(chemotherapy_type == "Neoadjuvant" |
  #          (chemotherapy_type == "Adjuvant" &
  #             linenumber_adj == 1)) %>%

  mutate(relative_dose_intensity = amount / expected_dose # adjusted_expected_dose
  ) %>%
  # select(patientid,linenumber, linenumber_new, chemotherapy_type, drugname_type, drugname,
  #        relative_dose_intensity, linenumber_adj) %>%
  
  # Average RDI by drug by line (will NOT combine pacli-doce and cis-carbo-oxalo)
  group_by(patientid, chemotherapy_type, drugname) %>%
  # mutate(mean_RDI_per_drug = case_when(
  #   chemotherapy_type == "Adjuvant" &
  #     linenumber_adj == 1                  ~ round(mean(relative_dose_intensity, na.rm = TRUE), 3),
  #   chemotherapy_type == "Neoadjuvant"     ~ round(mean(relative_dose_intensity, na.rm = TRUE), 3)
  # )) %>% 
  mutate(mean_RDI_per_drug = round(mean(relative_dose_intensity, na.rm = TRUE), 3)
  ) %>% 
  ungroup()

RDI_data <- Treatment %>% 
  distinct(patientid, chemotherapy_type, drugname, .keep_all = TRUE) %>% 
  mutate(mean_RDI_per_drug = na_if(mean_RDI_per_drug, "NaN"))
```

```{r RDI calculation group}
RDI_data <- RDI_data %>% 
  # general
  mutate(RDI_grp = case_when(
    mean_RDI_per_drug >= 0.85              ~ "Adequate dosing",
    mean_RDI_per_drug < 0.85               ~ "Underdosed"
  )) %>% 
  mutate(RDI_grp = factor(RDI_grp, 
                           levels = c("Adequate dosing", "Underdosed"))) %>% 
  mutate(RDI_grp1 = case_when(
    mean_RDI_per_drug < 0.75               ~ "Highly underdosed",
    mean_RDI_per_drug >= 0.75 &
      mean_RDI_per_drug < 0.85             ~ "Underdosed",
    mean_RDI_per_drug >= 0.85 &
      mean_RDI_per_drug < 1.1              ~ "Adequate dosing",
    mean_RDI_per_drug >= 1.1               ~ "Overdosing"
  )) %>% 
  mutate(RDI_grp1 = factor(RDI_grp1, 
                          levels = c("Adequate dosing",
                                     "Underdosed", 
                                     "Highly underdosed",
                                     "Overdosing"))) %>% 
  # separated
  mutate(RDI_carbo_neo = case_when(
    drugname == "carboplatin" &
      chemotherapy_type == "Neoadjuvant"    ~ mean_RDI_per_drug,
    TRUE                                    ~ NA_real_
  )) %>% 
  mutate(RDI_pacli_neo = case_when(
    drugname == "paclitaxel" &
      chemotherapy_type == "Neoadjuvant"    ~ mean_RDI_per_drug,
    TRUE                                    ~ NA_real_
  )) %>% 
  mutate(RDI_carbo_adj = case_when(
    drugname == "carboplatin" &
      chemotherapy_type == "Adjuvant"    ~ mean_RDI_per_drug,
    TRUE                                    ~ NA_real_
  )) %>% 
  mutate(RDI_pacli_adj = case_when(
    drugname == "paclitaxel" &
      chemotherapy_type == "Adjuvant"    ~ mean_RDI_per_drug,
    TRUE                                    ~ NA_real_
  )) %>% 
  
  mutate(RDI_carbo_neo_grp = case_when(
    RDI_carbo_neo >= 0.85              ~ "Adequate dosing",
    RDI_carbo_neo < 0.85               ~ "Underdosed"
  )) %>% 
  mutate(RDI_carbo_neo_grp = factor(RDI_carbo_neo_grp, 
                           levels = c("Adequate dosing", "Underdosed"))) %>% 
  mutate(RDI_carbo_neo_grp1 = case_when(
    RDI_carbo_neo < 0.75               ~ "Highly underdosed",
    RDI_carbo_neo >= 0.75 &
      RDI_carbo_neo < 0.85             ~ "Underdosed",
    RDI_carbo_neo >= 0.85 &
      RDI_carbo_neo < 1.1              ~ "Adequate dosing",
    RDI_carbo_neo >= 1.1               ~ "Overdosing"
  )) %>% 
  mutate(RDI_carbo_neo_grp1 = factor(RDI_carbo_neo_grp1, 
                          levels = c("Adequate dosing",
                                     "Underdosed", 
                                     "Highly underdosed",
                                     "Overdosing"))) %>% 
  mutate(RDI_pacli_neo_grp = case_when(
    RDI_pacli_neo >= 0.85              ~ "Adequate dosing",
    RDI_pacli_neo < 0.85               ~ "Underdosed"
  )) %>% 
  mutate(RDI_pacli_neo_grp = factor(RDI_pacli_neo_grp, 
                           levels = c("Adequate dosing", "Underdosed"))) %>% 
  mutate(RDI_pacli_neo_grp1 = case_when(
    RDI_pacli_neo < 0.75               ~ "Highly underdosed",
    RDI_pacli_neo >= 0.75 &
      RDI_pacli_neo < 0.85             ~ "Underdosed",
    RDI_pacli_neo >= 0.85 &
      RDI_pacli_neo < 1.1              ~ "Adequate dosing",
    RDI_pacli_neo >= 1.1               ~ "Overdosing"
  )) %>% 
  mutate(RDI_pacli_neo_grp1 = factor(RDI_pacli_neo_grp1, 
                          levels = c("Adequate dosing",
                                     "Underdosed", 
                                     "Highly underdosed",
                                     "Overdosing"))) %>% 
  
  mutate(RDI_carbo_adj_grp = case_when(
    RDI_carbo_adj >= 0.85              ~ "Adequate dosing",
    RDI_carbo_adj < 0.85               ~ "Underdosed"
  )) %>% 
  mutate(RDI_carbo_adj_grp = factor(RDI_carbo_adj_grp, 
                           levels = c("Adequate dosing", "Underdosed"))) %>% 
  mutate(RDI_carbo_adj_grp1 = case_when(
    RDI_carbo_adj < 0.75               ~ "Highly underdosed",
    RDI_carbo_adj >= 0.75 &
      RDI_carbo_adj < 0.85             ~ "Underdosed",
    RDI_carbo_adj >= 0.85 &
      RDI_carbo_adj < 1.1              ~ "Adequate dosing",
    RDI_carbo_adj >= 1.1               ~ "Overdosing"
  )) %>% 
  mutate(RDI_carbo_adj_grp1 = factor(RDI_carbo_adj_grp1, 
                          levels = c("Adequate dosing",
                                     "Underdosed", 
                                     "Highly underdosed",
                                     "Overdosing"))) %>% 
  mutate(RDI_pacli_adj_grp = case_when(
    RDI_pacli_adj >= 0.85              ~ "Adequate dosing",
    RDI_pacli_adj < 0.85               ~ "Underdosed"
  )) %>% 
  mutate(RDI_pacli_adj_grp = factor(RDI_pacli_adj_grp, 
                           levels = c("Adequate dosing", "Underdosed"))) %>% 
  mutate(RDI_pacli_adj_grp1 = case_when(
    RDI_pacli_adj < 0.75               ~ "Highly underdosed",
    RDI_pacli_adj >= 0.75 &
      RDI_pacli_adj < 0.85             ~ "Underdosed",
    RDI_pacli_adj >= 0.85 &
      RDI_pacli_adj < 1.1              ~ "Adequate dosing",
    RDI_pacli_adj >= 1.1               ~ "Overdosing"
  )) %>% 
  mutate(RDI_pacli_adj_grp1 = factor(RDI_pacli_adj_grp1, 
                          levels = c("Adequate dosing",
                                     "Underdosed", 
                                     "Highly underdosed",
                                     "Overdosing")))
RDI_data %>% distinct(patientid) %>% nrow()
```

```{r RDI_data}
RDI_data <- RDI_data %>% 
  group_by(patientid) %>% 
  fill(RDI_carbo_neo, RDI_carbo_neo_grp, RDI_carbo_neo_grp1, 
       RDI_pacli_neo, RDI_pacli_neo_grp, RDI_pacli_neo_grp1, 
       RDI_carbo_adj, RDI_carbo_adj_grp, RDI_carbo_adj_grp1, 
       RDI_pacli_adj, RDI_pacli_adj_grp, RDI_pacli_adj_grp1, 
       .direction = "downup") %>% 
  ungroup()
Frontline_adjusted <- RDI_data %>% 
  distinct(patientid, .keep_all = TRUE)
```

```{r}
# rm(areaUC, body_surface_area, creatinine, clinical_data, drugs, drugs1, 
#    height#, therapy_cycle, therapy_line, Treatment, weight
#    )
```

<br>
<br>

# **Number of patients : `r Frontline_adjusted %>% distinct(patientid) %>% nrow()`**

######################################################################################################################
######################################################################################################################
######################################################################################################################
######################################################################################################################

<!-- # Variable for filtering -->

<!-- ```{r rule between diagnosis and treatment} -->
<!-- drugs1 <- Frontline_adjusted %>%  -->
<!--   # 1. 60 days rule between diagnosis and treatment # Loss 1 -->
<!--   group_by(patientid) %>%  -->
<!--   mutate(first_drug_date = first(episodedate)) %>%  -->
<!--   mutate(days_at_first_drug = interval(start = diagnosisdate, end = first_drug_date)/ -->
<!--            duration(n=1, units = "days")) %>%  -->
<!--   mutate(days_at_surg = interval(start = diagnosisdate, end = surgerydate)/ -->
<!--            duration(n=1, units = "days")) %>%  -->
<!--   ungroup() %>%  -->
<!--   mutate(thirty_days_exclusion = interval(start = diagnosisdate, end = dateofdeath)/ -->
<!--            duration(n=1, units = "days") -->
<!--   ) -->
<!-- ``` -->

<br>

## 1. step 1: Flatiron recommendation cleanup

This step is to remove patients from the population that don't follow flatiron recommendations.  

- 90 days rule between diagnosis and treatment  
Flatiron propose a conceptual instruction on the 90-day-gap : 90 days between diagnosis and treatment.  
It is meant to exclude patients who didn't get treatment for 90 days which would most likely mean that some treatment data are missing. Patients left after this step:

- 30 days rule excluding patient who didn't survive for at least 30 days after diagnosis  
This is something that Flatiron strongly recommends, but does not require. Flatiron proposal reviewers will likely provide comments on this if not incorporated into a proposal. 

- Exclude exclude == "1" coded by Lauren

Are excluded :  
-	Borderline cases (not invasive ovarian cancer)  
-	Data from one PracticeID  (Flatiron requested removal of this practice ID from the dataset)  
-	Certain historical structured data were not available for patients seen at academic sites prior to 2015 – Flatiron has asked that if conducting survival analyses, these patients are removed (patients diagnosed < 2015 at academic sites)  
```{r}
flatiron_rec <- Frontline_adjusted %>% 
  filter(is.na(flatiron_rules))
```

**At the end of the step 1, we have `r flatiron_rec %>% distinct(patientid) %>% nrow()` patients.** 

<br>

## 2. step 2: Filter patients with clinical characteristics fitting to the study criteria

- exclude patients whose histology is unknown  
- remove chemotherapy only patients
- include only patients who received platin and/or taxane
- exclude patients who only received neo + surgery
- include patients with single or dual P/T +/- Bev as frontline treatment
```{r}
study_criteria <- flatiron_rec %>% 
  filter(!is.na(histology))

study_criteria <- study_criteria %>%
  filter(!is.na(surgerydate))

study_criteria <- study_criteria %>%
  filter(had_carbo_pacli == "Yes")

study_criteria <- study_criteria %>% 
  filter(treatment_sequence == "neo + surg + adj" |
           treatment_sequence == "surg + adj")

# F0017FB3A8828 starts with gemcitabine then have carbo

study_criteria <- study_criteria %>%
  filter(is.na(line_keep))
  # Remove patients with other linename
  # filter((linenumber_new == 1 &
  #          (linename == "Carboplatin,Paclitaxel" |
  #          linename == "Bevacizumab,Carboplatin,Paclitaxel" |
  #          linename == "Carboplatin" |
  #          linename == "Paclitaxel" |
  #          linename == "Bevacizumab,Paclitaxel" |
  #          linename == "Bevacizumab,Carboplatin")) |
  #         (linenumber_new == 2 &
  #         therapy == "Upfront Chemo" &
  #          (linename == "Carboplatin,Paclitaxel" |
  #          linename == "Bevacizumab,Carboplatin,Paclitaxel" |
  #          linename == "Carboplatin" |
  #          linename == "Bevacizumab,Paclitaxel" |
  #          linename == "Paclitaxel" |
  #          linename == "Bevacizumab,Carboplatin"))
  #        )
```

**At the end of the step 2, we have `r study_criteria %>% distinct(patientid) %>% nrow()` patients.** 

<br>

## 3. step 3: Filter out patients with missing data

- exclude the patients who had surgery but we don't have a date of surgery -> NONE removed anymore  
- remove patients with long gap between surgery and adjuvant start (3  months) -> NONE removed anymore  
- exclude patients with a date of drug or date of surgery BEFORE diagnosis will be excluded (inclined to be wrongly recorded)
- exclude patients for whose no RDI were available

```{r}
missing_data <- study_criteria %>% 
  filter(!(issurgery == "Yes" & is.na(surgerydate))) 

missing_data <- missing_data %>%
  filter(is.na(gap_surg_drugs))

missing_data <- missing_data %>% 
  filter(days_at_first_drug >= 0 &
           (is.na(surgerydate) | days_at_surg >= 0)
         )

missing_data <- missing_data %>% 
  # remove these patients who switched C > C 
  filter((
    therapy == "Upfront Chemo" &
      (!is.na(RDI_carbo_neo) & !is.na(RDI_pacli_neo) & 
         !is.na(RDI_carbo_adj) & !is.na(RDI_pacli_adj)) 
  ) | (
    therapy == "Upfront Surgery" &
      (!is.na(RDI_carbo_adj) & !is.na(RDI_pacli_adj))
  )
  )
```
**At the end of the step 3, we have `r missing_data %>% distinct(patientid) %>% nrow()` patients.** 

## 4. step 4: Include patients with treatments following the standard of clinical care

- exclude patients with more than 1 line as Neo
- exclude patients with maintenance within their frontline
- exclude patients with more than 6 cycles in Neo, more than 9 cycles **total** in upfront chemo or more than 9 cycles in upfront surgery
```{r}
standard_care <- missing_data %>% 
  # Remove patients with more than 1 line as Neo
  filter(is.na(neo_more_more_than_1line))

standard_care <- standard_care %>% 
  filter(is.na(frontline_has_maintenance))

standard_care <- standard_care %>% 
  filter(is.na(too_many_cycle))
```
**We have `r standard_care %>% distinct(patientid) %>% nrow()` patients.** 





- Exclude patients that received wrong dose dense of 1 carbo + 2 paclitaxels
```{r}
Frontline_adjusted <- standard_care %>% 
  filter(is.na(wrong_pacli_dosedense))

# standard_care %>% 
#   mutate(n_dose_dense = factor(n_dose_dense)) %>% 
#   select(n_dose_dense, therapy) %>% 
#   tbl_summary(by = therapy)

# test <- Frontline %>% 
#   filter(wrong_pacli_dosedense == "exclude")
# 
# wrong_pacli_dosedense <- Treatment %>% arrange(patientid, episodedate, drugname) %>% 
#   filter(str_detect(patientid, paste(test$patientid, collapse = "|"))) %>% 
#   select(patientid, chemotherapy_type, therapy, episodedate, drugname, ismaintenancetherapy, linenumber_new, cycle_increment, too_many_cycle, dose_dense, wrong_pacli_dosedense,  linename)
```
**We have `r Frontline_adjusted %>% distinct(patientid) %>% nrow()` patients.** 


```{r}
# d <- end_patients_Treatment %>% 
#   select(patientid, linename, linenumber_new, chemotherapy_type, therapy, cycle_increment, total_cycle_increment, ismaintenancetherapy)

# end_patients_Treatment %>% 
#   mutate(total_cycle_increment = factor(total_cycle_increment)) %>% 
#   arrange(desc(total_cycle_increment)) %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(total_cycle_increment, therapy) %>% 
#   tbl_summary(by = therapy)
```

- exclude patients who switch drug within a line

<!-- Patients left: -->
```{r}
# switch cispl vs carbo  Car > Cis F1BF7208F0E96

# remove_switch <- therapy_line %>% 
#   filter(linenumber_adj == 1 &
#     ((str_detect(linename, "Carboplatin") & drugname == "cisplatin") |
#   (str_detect(linename, "Cisplatin") & drugname == "carboplatin"))
#   ) %>%
#   distinct(patientid)
# remove_switch <- paste(remove_switch$patientid, collapse = "|")
# 
# therapy_line <- therapy_line %>% 
#   # remove these patients who switched C > C 
#   filter(!str_detect(patientid, remove_switch))
# therapy_line %>% distinct(patientid) %>% nrow()
```

<!-- Patients left: -->
```{r}
Frontline_adjusted <- Frontline_adjusted %>%
  filter(is.na(switch_drugs))
```













<!-- TABLES -->

```{r}
# missing_data %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(had_neo, had_adj, therapy) %>% 
#   tbl_summary(by = therapy,
#               type = list(had_neo ~ "dichotomous", 
#                           had_adj ~ "dichotomous"),
#               missing = "no")
# # therapy_line %>% 
# #   distinct(patientid, .keep_all = TRUE) %>% 
# #   select(therapy, treatment_sequence) %>% 
# #   tbl_summary(by = therapy)
```


<!-- First table is frontline Neo, second table is frontline Adj. -->
```{r}
# # drugs1 %>% Need to do in Frontline
#   filter(linenumber == 1
#          ) %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(linename) %>% 
#   tbl_summary(sort = list(everything() ~ "frequency"))
# 
# # missing_data %>% 
# #   filter(linenumber_new == 2, therapy == "Upfront Chemo") %>% 
# #   distinct(patientid, .keep_all = TRUE) %>% 
# #   select(linename) %>% 
# #   tbl_summary(sort = list(everything() ~ "frequency"))
```

<!-- ### Number of patient who switch line because of surgery from line 1 neoadjuvant to an adjuvant line -->
```{r Number of patient who switch line}
# therapy_line %>% 
#   mutate(change_line = case_when(
#     linenumber == 1 & 
#       linenumber_new == 2 &
#       chemotherapy_type == "Adjuvant" &
#       therapy == "Upfront Chemo"                   ~ 1,
#     TRUE                                           ~ 0
#   )) %>% 
#   arrange(desc(change_line)) %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(change_line) %>% 
#   tbl_summary()
```

<!-- For these patients, I was worried that the part of their first line which was switched to Adjuvant line because of surgery is short... How long is this adjuvant line? -->
```{r}
# therapy_line %>% 
#   mutate(line_duration = interval(start = linestartdate_new, end = lineenddate_new)/ 
#            duration(n = 1, units = "days")) %>% 
#   filter(linenumber == 1 & linenumber_new == 2) %>% 
#   # select(patientid, linenumber, linenumber_new, linenumber_adj, 
#   #        drugname, chemotherapy_type, therapy, episodedate, line_duration) %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   ggplot(aes(x= line_duration))+
#   geom_histogram(aes(fill = route), binwidth = 7) +
#   theme_minimal(base_size = 14)+
#   labs(x="Line duration", 
#        y="Number of Patient",
#        caption = "Each bar represents 7 days, bottom plot is zoomed in")+
#   ggforce::facet_zoom(xlim = c(0, 100), zoom.size = 1)
```
<!-- Several patients have a short line.   -->
<!-- `r emo::ji("question_mark")` **Should we remove the patient with a line lasting less than a cycle** We said during October meeting to check if were IP administration.... -->

```{r}
# therapy_line %>% 
#   mutate(line_duration = interval(start = linestartdate_new, end = lineenddate_new)/ 
#            duration(n = 1, units = "days")) %>% 
#   filter(linenumber == 1 & linenumber_new == 2) %>% 
#   select(patientid, surgerydate, episodedate, line_duration, drugname,
#          chemotherapy_type, therapy, 
#          linenumber, linenumber_new, route, amount) %>% 
#   filter(line_duration < 30) %>% 
#   arrange(line_duration, patientid, episodedate)
```




<!-- Here a real example of this type of patient : initial `linenumber` = 1 but had surgery in 09/2019 so part of this line in moved to `linenumber_new` = 2 and then coded as adjuvant line.   -->
<!-- So when we will calculate RDI for frontline adjuvant, it will only include this 1 cycle. <span style="color:red">**Is that correct?**</span>   -->
```{r Number of patient who switch line2, rows.print=30}
# Problem F0000AD999ABF but would be good for F003F2BEEDB37
# therapy_line %>% 
#   filter(str_detect(patientid, "F41E15E18E008")) %>% 
#   arrange(patientid, episodedate) %>% 
#   select(linenumber, linenumber_new, episodedate, chemotherapy_type, drugname)
```

<!-- Here an example a little more complicated because the patient had surgery 05/2017 and the same type of switch but then had a 3rd line (used to be line 2 in flatiron).     -->
<!-- So when we will calculate RDI for frontline adjuvant, it will only include this 1 cycle switched to adjuvant and not the longer line witch was coded 2 by flatiron. <span style="color:red">**Is that correct?**</span>   -->
```{r, rows.print=30}
# therapy_line %>% 
#   filter(str_detect(patientid, "FC9D28216FEBE")) %>% 
#   arrange(patientid, episodedate) %>% 
#   select(linenumber, linenumber_new, episodedate, chemotherapy_type, drugname)

# therapy_line %>% 
#   mutate(change_line = case_when(
#     linenumber == 1 & 
#       linenumber_new == 2 &
#       chemotherapy_type == "Adjuvant" &
#       treatment_sequence == "neo + surg + adj"     ~ 1,
#     TRUE                                           ~ 0
#   )) %>% 
#   filter(change_line == 1) %>% 
#   group_by(patientid) %>% 
#   mutate(firstdate = first(episodedate)) %>% 
#   mutate(lastdate = last(episodedate)) %>% 
#   ungroup() %>% 
#   mutate(time_of_switch_line = interval(start = firstdate, end = lastdate) / duration(n =1, units = "days")) %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   ggplot(aes(x=time_of_switch_line, fill = ..count..))+
#   geom_histogram(binwidth = 7)+
#   theme_minimal(base_size = 14)+
#   ggforce::facet_zoom(xlim= c(0,60), zoom.size = 1) + 
#   scale_y_continuous(#breaks=c(0, 50, 100, 150),
#                      minor_breaks=c(10, 20, 30, 40)#,
#                      #labels = c(0, 50, 100, 150)
#   )
```
<!-- `r emo::ji("question_mark")`   -->
<!-- <span style="color:red">**So the bigger question is : Is it acceptable to include the patients who have a switched line?**</span> -->






<!-- <span style="color:red">**Random question : within 1 cycle we can have taxanes multiple times, is it possible for carboplatin or cisplatin?**</span>   -->








<br>
<br>

# **The final number of patients in the dataset is `r Frontline_adjusted %>% distinct(patientid) %>% nrow()`**

# Imputation for stagecat and debulking status

https://bookdown.org/mwheymans/bookmi/data-analysis-after-multiple-imputation.html#data-analysis-in-spss
https://www.ebpi.uzh.ch/dam/jcr:dc0cef17-29c7-4e61-8d33-e690561ab7ae/mi_intro20191001.pdf

Select the variables that may be important for predicting stagecat and debulking status:  
patientid, month_at_os, vitalstatus, raceeth, ageatdx, stagecat, debulking, histology, diagnosisdate, surgerydate, RDI_carbo_neo, RDI_pacli_neo, RDI_carbo_adj, RDI_pacli_adj BUT NOT therapy.  
Look at the Cox regression model before imputation.

### For Upfront Chemo
```{r}
data <- Frontline_adjusted %>% 
  filter(therapy == "Upfront Chemo") %>% 
  select(patientid, month_at_os, vitalstatus, 
         raceeth, diagnosisdate, surgerydate,
         ageatdx, stagecat, debulking, histology,
         RDI_carbo_neo, RDI_pacli_neo, 
         RDI_carbo_adj, RDI_pacli_adj
         # therapy
  )
nonimp_cox_model <-
  coxph(Surv(month_at_os, vitalstatus) ~ RDI_carbo_neo + RDI_pacli_neo + RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + debulking + histology,
        data = data)
nonimp_cox_model

Hazard <- nelsonaalen(data, month_at_os, vitalstatus)
dataset <- data.frame(data, Hazard)
```

Start imputation to look at matrix
```{r}
Cox.imp <- mice(dataset, m=1, maxit=0, seed=123, printFlag=F)
# summary(Cox.imp)
Pred <- Cox.imp$predictorMatrix
# Pred["debulking", "month_at_os"] <- 0
Pred
```

patientid is not used which is good. But SURGERYDATE IS NOT.
```{r}
Pred[, "surgerydate"] <- 1
Pred["surgerydate", "surgerydate"] <- 0
Pred
```

Imputation and cox regression model on imputed data using the new predictor matrix.
```{r}
# Start imputations using mice
Cox.imp <- mice(dataset, m=5, maxit=50, 
                predictorMatrix=Pred,
                seed=123, printFlag=F)
check1 <- with(data = Cox.imp,
       exp = coxph(
         Surv(month_at_os, vitalstatus) ~ RDI_carbo_neo + RDI_pacli_neo + RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + debulking + histology
       ))
pool(check1)$pooled
```

Do m = 30 (how to choose is explained in https://www.ebpi.uzh.ch/dam/jcr:dc0cef17-29c7-4e61-8d33-e690561ab7ae/mi_intro20191001.pdf depends of the fmi. The max fmi = 0.30 that we multiply by 100)
```{r}
Cox.imp <- mice(dataset, m=30, maxit=50, 
                predictorMatrix=Pred,
                seed=123, printFlag=F)

fit.Cox <-
  with(data = Cox.imp,
       exp = coxph(
         Surv(month_at_os, vitalstatus) ~ RDI_carbo_neo + RDI_pacli_neo + RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + debulking + histology
       ))

summary(pool(fit.Cox), conf.int = TRUE, exponentiate = TRUE) %>%
  kableExtra::kable() %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
Above results are exponentiated (imputed data).  
As a reminder before imputation results are :
```{r}
nonimp_cox_model
```

Complete the chemo data and merge with original
```{r}
imputed_data_chemo <- complete(Cox.imp, include = FALSE) %>% 
  rename(imp_stagecat = stagecat, imp_debulking = debulking)
```

Select the variables that may be important for predicting stagecat and debulking status:  
patientid, month_at_os, vitalstatus, raceeth, ageatdx, stagecat, debulking, histology, diagnosisdate, surgerydate, RDI_carbo_adj, RDI_pacli_adj BUT NOT therapy.  

### For Upfront Surgery
```{r}
data <- Frontline_adjusted %>% 
  filter(therapy == "Upfront Surgery") %>% 
  select(patientid, month_at_os, vitalstatus, 
         raceeth, diagnosisdate, surgerydate,
         ageatdx, stagecat, debulking, histology,
         RDI_carbo_adj, RDI_pacli_adj
         # therapy
  )
nonimp_cox_model <-
  coxph(Surv(month_at_os, vitalstatus) ~ RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + debulking + histology,
        data = data)
nonimp_cox_model

Hazard <- nelsonaalen(data, month_at_os, vitalstatus)
dataset <- data.frame(data, Hazard)
```

Start imputation to look at matrix
```{r}
Cox.imp <- mice(dataset, m=1, maxit=0, seed=123, printFlag=F)
# summary(Cox.imp)
Pred <- Cox.imp$predictorMatrix
# Pred["debulking", "month_at_os"] <- 0
Pred
```

patientid is not used which is good. But SURGERYDATE IS NOT
```{r}
Pred[, "surgerydate"] <- 1
Pred["surgerydate", "surgerydate"] <- 0
Pred
```

Imputation and cox regression model on imputed data using the new predictor matrix.
```{r}
# Start imputations using mice
Cox.imp <- mice(dataset, m=5, maxit=50, 
                predictorMatrix=Pred,
                seed=123, printFlag=F)
check1 <- with(data = Cox.imp,
       exp = coxph(
         Surv(month_at_os, vitalstatus) ~ RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + debulking + histology
       ))
pool(check1)$pooled
```

Do m = 10 (The max fmi = 0.099 that we multiply by 100)
```{r}
Cox.imp <- mice(dataset, m=10, maxit=50, 
                predictorMatrix=Pred,
                seed=123, printFlag=F)

fit.Cox <-
  with(data = Cox.imp,
       exp = coxph(
         Surv(month_at_os, vitalstatus) ~ RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + debulking + histology
       ))

summary(pool(fit.Cox), conf.int = TRUE, exponentiate = TRUE) %>%
  kableExtra::kable() %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
Above results are exponentiated (imputed data).  
As a reminder before imputation results are :
```{r}
nonimp_cox_model
```

Complete the data and merge with original
```{r}
imputed_data_surg <- complete(Cox.imp, include = FALSE) %>% 
  rename(imp_stagecat = stagecat, imp_debulking = debulking)

imputed_data <- bind_rows(imputed_data_chemo, imputed_data_surg)

# Frontline <- 
#   full_join(Frontline, imputed_data %>% 
#               select(patientid, starts_with("imp_")), 
#             by = "patientid") 
Frontline_adjusted <- 
  full_join(Frontline_adjusted, imputed_data %>% 
              select(patientid, starts_with("imp_")), 
            by = "patientid") 
```


***

<br>

# Consort diagram

```{r consort}
library(ggconsort)
study_cohorts <- 
  Frontline_adjusted %>%
  cohort_start("Assessed for eligibility") %>%
  # Define cohorts using named expressions
  # Notice that you can use previously defined cohorts in subsequent steps
  cohort_define(
  flatiron_rec = .full %>% filter(is.na(flatiron_rules)),
  
  study_criteria = flatiron_rec  %>% 
    filter(!is.na(histology)) %>%
    filter(!is.na(surgerydate)) %>%
    filter(had_carbo_pacli == "Yes") %>% 
    filter(treatment_sequence == "neo + surg + adj" |
             treatment_sequence == "surg + adj") %>%
    filter(is.na(line_keep)),
  
    missing_data = study_criteria  %>% 
    filter(!(issurgery == "Yes" & is.na(surgerydate))) %>%
    filter(is.na(gap_surg_drugs)) %>%
    filter(days_at_first_drug >= 0 &
             (is.na(surgerydate) | days_at_surg >= 0)) %>%
    filter((!is.na(RDI_carbo_neo) & !is.na(RDI_pacli_neo) &
              !is.na(RDI_carbo_adj) & !is.na(RDI_pacli_adj) &
              therapy == "Upfront Chemo") |
             (!is.na(RDI_carbo_adj) & !is.na(RDI_pacli_adj &
               therapy == "Upfront Surgery"))),
  
    standard_care = missing_data %>% 
    filter(is.na(neo_more_more_than_1line)) %>%
    filter(is.na(frontline_has_maintenance)) %>%
    filter(is.na(too_many_cycle)),
  
  Frontline = standard_care %>% 
    filter(is.na(wrong_pacli_dosedense)),
  Frontline1 = Frontline %>%
    filter(is.na(switch_drugs))
  ) %>%
  # Provide text labels for cohorts
  cohort_label(
    flatiron_rec = "**flatiron_rec**",
    study_criteria = "*study_criteria*",
    missing_data = "missing_data",
    standard_care = "standard_care",
    Frontline = "Frontline",
    Frontline1 = "Population Study"
  )
study_cohorts

study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "flatiron_rec", 5, 45, glue::glue(
      "{cohort_count_adorn(study_cohorts, flatiron_rec)}<br> 
      • <span style='color:darkgreen'>**90 days rule between diagnosis and treatment**</span> <br>
      • 30 days rule excluding patient who didn't survive <br> for at least 30 days after diagnosis <br>
      • Borderline cases (not invasive ovarian cancer) <br>
      • Data from one PracticeID <br>
      • historical structured data were not available for <br> patients seen at academic sites prior to 2015
      ")
    
    
    
  ) %>%
  consort_box_add(
    "study_criteria", 5, 35, cohort_count_adorn(study_cohorts, study_criteria)
  ) %>%
  consort_box_add(
    "missing_data", 5, 30, cohort_count_adorn(study_cohorts, missing_data)
  ) %>%
  consort_box_add(
    "standard_care", 5, 25, cohort_count_adorn(study_cohorts, standard_care)
  ) %>%
  consort_box_add(
    "Frontline", 5, 20, cohort_count_adorn(study_cohorts, Frontline)
  ) %>%
  consort_box_add(
    "Frontline1", 0, 15, cohort_count_adorn(study_cohorts, Frontline1)
  ) %>%
  
  consort_arrow_add(
    end = "flatiron_rec", end_side = "left", start_x = 0, start_y = 45
  ) %>%
  consort_arrow_add(
    end = "study_criteria", end_side = "left", start_x = 0, start_y = 35
  ) %>%
  consort_arrow_add(
    end = "missing_data", end_side = "left", start_x = 0, start_y = 30
  ) %>%
  consort_arrow_add(
    end = "standard_care", end_side = "left", start_x = 0, start_y = 25
  ) %>%
  consort_arrow_add(
    end = "Frontline", end_side = "left", start_x = 0, start_y = 20
  ) %>%
  consort_arrow_add(
    end = "Frontline1", end_side = "top", start_x = 0, start_y = 50
  )

study_consort %>%
  ggplot() + 
  geom_consort() +
  theme_consort(margin_h = 18, margin_v = 1)
```

<br>

***

# II.Data analysis
## Explore the dataset

```{r}
full_data_study_pop <- 
  Treatment %>% 
  filter(str_detect(patientid, paste(Frontline_adjusted$patientid, collapse = "|"))) %>% 
  arrange(patientid, episodedate, drugname)
```

### Number of line /cycle received by patients in our study population 

<span style="color:green">**Table supp 1 Number of total line**</span>
```{r}
full_data_study_pop %>% 
  arrange(desc(linenumber_new)) %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  select(linenumber_new, therapy) %>% 
  tbl_summary(by = therapy)
```

<span style="color:green">**Table supp 1 Number of cycle in Neo**</span>
```{r}
full_data_study_pop %>% 
  filter(chemotherapy_type == "Neoadjuvant") %>% 
  arrange(desc(cycle_increment)) %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(cycle_increment) %>% 
  tbl_summary()
full_data_study_pop %>% 
  filter(chemotherapy_type == "Neoadjuvant") %>% 
  arrange(desc(cycle_increment)) %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(cycle_increment) %>% 
  tbl_summary(type = list(cycle_increment ~ "continuous"))
```

<span style="color:green">**Table supp 1 Number of cycle in Adj**</span>
```{r}
full_data_study_pop %>% 
  filter(chemotherapy_type == "Adjuvant" & linenumber_adj == 1) %>% 
  arrange(desc(cycle_increment)) %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(cycle_increment, therapy) %>% 
  tbl_summary(by = therapy)
full_data_study_pop %>% 
  filter(chemotherapy_type == "Adjuvant" & linenumber_adj == 1) %>% 
  arrange(desc(cycle_increment)) %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(cycle_increment, therapy) %>% 
  tbl_summary(by = therapy,
              type = list(cycle_increment ~ "continuous"))
```
<br>


```{r}
Frontline <- Frontline_adjusted
```

<!-- ## Missingness -->
<!-- Here some representation of missingness in our data:   -->
<!-- - In the first plot (horizontal bar), `r is.na(Frontline$height_at_dx) %>% sum()` data is missing for height closest to dx but `r Frontline %>% filter(is.na(weight_at_dx)) %>% distinct(patientid) %>% nrow()` is missing for weight  at dx (consequently bmi and bsa  at dx). Because these parameters overlap only 25 patients will have missing value for all of them.    -->
<!-- - In the second plot (horizontal bar), `r is.na(Frontline$CrCl) %>% sum()` data is missing for creatinine clearance, `r is.na(Frontline$target_auc) %>% sum()` data is missing for the taget_auc (hold on to the thought that this parameter include the target AUC calculated for Carboplatin and target dose calculated for cisplatin and taxanes, they are just present in the same column for a tidy data organisation). the vertical bar show that 413 info are missing for the intersection of the 4 parameters creatinine + creatinine clearance + target_auc + expected dose. -->
```{r}
# library(naniar)
# 
# Frontline %>% select(creatinine, CrCl, target_auc, expected_dose) %>% 
#   gg_miss_upset()

# is.na(Frontline$CrCl) %>% sum()
# is.na(Frontline$amount) %>% sum()
# is.na(Frontline$target_auc) %>% sum()

# Frontline %>% filter(is.na(amount)) %>%
#     distinct(patientid, .keep_all = TRUE) %>% nrow()
# 
# Frontline %>% filter(is.na(target_auc) | is.na(expected_dose)) %>%
#     distinct(patientid, .keep_all = TRUE) %>% nrow()
```
<!-- If we remove patients who have at least 1 missing amount administered, we lose `r Frontline %>% filter(is.na(amount)) %>% distinct(patientid, .keep_all = TRUE) %>% nrow()` patients.   -->

<!-- If we remove patients who are missing at least 1 target_auc or 1 expected dose we lose `r Frontline %>% filter(is.na(target_auc) | is.na(expected_dose)) %>% distinct(patientid, .keep_all = TRUE) %>% nrow()` patients.   -->

<br>
<br>

***

# Clinical Analysis

## 1.Clinical summary table

<span style="color:green">**Table 1 Overall summary demographic/clinical data**</span>
```{r Table 1}
Frontline %>% distinct(patientid, .keep_all = TRUE) %>% 
  select(c(vital, raceeth, 
           agecat, "ageatdx",
            
           bmi_at_dx, bmi_cat, 
           weight_at_dx, height_at_dx, bsa_at_dx,
           
           "histology", "stagecat", imp_stagecat,
           
           "brca1_germline", "brca2_germline", "brca_germline", "brca1_tumor",
           "brca2_tumor", "brca_tumor", "brca1_unknown", "brca2_unknown", "brca_unknown")) %>% 
  tbl_summary() %>% bold_labels()
```

<span style="color:green">**Table 2 Summary demographic/clinical data by race**</span>
```{r Table 2}
Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  select(c(raceeth, "vital",
           agecat, "ageatdx",
            
           "bmi_at_dx", bmi_cat, "BSA",
           "stagecat", imp_stagecat)) %>% 
  tbl_summary(by = raceeth) %>% bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
```
<br>

<span style="color:green">**Table 3 Summary demographic/clinical data by bmi**</span>
```{r Table 3}
Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  select(c(raceeth, "vital",
           agecat, "ageatdx",
            
           "bmi_at_dx", bmi_cat, "BSA",
           "stagecat", imp_stagecat)) %>% 
  tbl_summary(by = bmi_cat) %>% bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
```
<br>

## 2.Clinical Plots
<div class = "row">
<div class = "col-md-6">
```{r plot clinical}
Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= bmi_cat))+
  geom_bar()+
  theme_minimal(base_size = 14)+
  labs(title = "BMI Category at Diagnosis")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= histology))+
  geom_bar()+
  theme_minimal(base_size = 14)+
  labs(title = "Histology")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= stagecat))+
  geom_bar()+
  theme_minimal(base_size = 14)+
  labs(title = "Stage")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= imp_stagecat))+
  geom_bar()+
  theme_minimal(base_size = 14)+
  labs(title = "Stage")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= agecat))+
  geom_bar()+
  theme_minimal(base_size = 14)+
  labs(title = "Age Category")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= brca_germline))+
  geom_bar()+
  theme_minimal(base_size = 14)+
  labs(title = "BRCA gernline")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= brca_tumor))+
  geom_bar()+
  theme_minimal(base_size = 14)+
  labs(title = "BRCA tumor")+
  coord_flip()
```
</div>

<div class = "col-md-6">
```{r}
Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= raceeth, fill = bmi_cat))+
  geom_bar(position = "fill")+
  theme_minimal(base_size = 14)+
  labs(title = "BMI category at Diagnosis")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= raceeth, fill = histology))+
  geom_bar(position = "fill")+
  theme_minimal(base_size = 14)+
  labs(title = "Histology")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= raceeth, fill = stagecat))+
  geom_bar(position = "fill")+
  theme_minimal(base_size = 14)+
  labs(title = "Stage")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= raceeth, fill = imp_stagecat))+
  geom_bar(position = "fill")+
  theme_minimal(base_size = 14)+
  labs(title = "Stage")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= raceeth, fill = agecat))+
  geom_bar(position = "fill")+
  theme_minimal(base_size = 14)+
  labs(title = "Age Category")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= raceeth, fill = brca_germline))+
  geom_bar(position = "fill")+
  theme_minimal(base_size = 14)+
  labs(title = "BRCA germline")+
  coord_flip()

Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= raceeth, fill = brca_tumor))+
  geom_bar(position = "fill")+
  theme_minimal(base_size = 14)+
  labs(title = "BRCA tumor")+
  coord_flip()
```
</div>
</div>

<br>

## 3.Survivals by clinical

<span style="color:green">**Survival plots from date of diagnosis on the left and from date of treatment on the right**</span>  

<div class = "row">
<div class = "col-md-6">
```{r clinical from dx, fig.height = 7}
# OS by raceeth
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ raceeth, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by tstage
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ stagecat, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ imp_stagecat, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by bmi_cat
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ bmi_cat, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))
```
</div>

<div class = "col-md-6">
```{r clinical from first treatment, fig.height = 7}
# OS by raceeth
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ raceeth, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by tstage
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ stagecat, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ imp_stagecat, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by bmi_cat
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ bmi_cat, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))
```
</div>
</div>

<br>
<br>

***

<br>

# II.Treatment Analysis

## 1.Treatment summary table

<span style="color:green">**Table 4 Summary treatment data by race**</span>
```{r Table 4}
# tbl1 <- 
  Frontline %>% distinct(patientid, .keep_all = TRUE) %>% 
  select(c(raceeth,
           "debulking", imp_debulking , "therapy"
           )) %>% 
  tbl_summary(by = raceeth) %>% bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
```
<br>

<span style="color:green">**Table 5 Summary treatment data by bmi**</span>
```{r Table 5}
Frontline %>% distinct(patientid, .keep_all = TRUE) %>% 
  select(c(bmi_cat,
           "debulking", imp_debulking, "therapy"
           )) %>% 
  tbl_summary(by = bmi_cat) %>% bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
```
<br>

## 2.Treatment Plots
<div class = "row">
<div class = "col-md-6">
```{r treatment plots}
Frontline %>%
  ggplot(aes(x= therapy))+
  geom_bar()+
  theme_minimal(base_size = 14)+
  labs(title = "Frontline treatment")+
  coord_flip()

Frontline %>%
  ggplot(aes(x= bmi_cat, fill= therapy))+
  geom_bar(position ="fill")+
  theme_minimal(base_size = 14)+
  labs(title = "Frontline treatment")+
  coord_flip()

Frontline %>%
  ggplot(aes(x= bmi_cat, fill= debulking))+
  geom_bar(position ="fill")+
  theme_minimal(base_size = 14)+
  labs(title = "Frontline treatment")+
  coord_flip()

Frontline %>%
  ggplot(aes(x= bmi_cat, fill= imp_debulking))+
  geom_bar(position ="fill")+
  theme_minimal(base_size = 14)+
  labs(title = "Frontline treatment")+
  coord_flip()

full_data_study_pop %>% 
  filter(linenumber_adj == 1) %>% 
  distinct(patientid, chemotherapy_type, .keep_all = TRUE) %>% 
  ggplot(aes(x= linename, fill= therapy))+
  geom_bar(aes(fill = therapy), position = position_dodge(preserve = "single"))+
  theme_minimal(base_size = 14) + 
  facet_wrap(. ~ chemotherapy_type)+
  coord_flip()

full_data_study_pop %>% 
  filter(linenumber_adj == 1) %>% 
  distinct(patientid, chemotherapy_type, .keep_all = TRUE) %>% 
  ggplot(aes(x= linename, fill= therapy))+
  geom_bar(aes(fill = therapy), position = position_dodge(preserve = "single"))+
  theme_minimal(base_size = 14) + 
  facet_wrap(raceeth ~ chemotherapy_type)+
  coord_flip()


full_data_study_pop %>% 
  filter(chemotherapy_type == "Neoadjuvant") %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  select(linename) %>% 
  tbl_summary(label = list(linename ~ "line name received as Neoadujant"))
full_data_study_pop %>% 
  filter(chemotherapy_type == "Adjuvant" & linenumber_adj == 1) %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  select(linename, therapy) %>% 
  tbl_summary(by = therapy,
              label = list(linename ~ "line name received as Adjuvant"))
```
</div>

<div class = "col-md-6">
```{r}
Frontline %>%
  ggplot(aes(x= raceeth, fill= therapy))+
  geom_bar(position ="fill")+
  theme_minimal(base_size = 14)+
  labs(title = "Frontline treatment")+
  coord_flip()

Frontline %>%
  ggplot(aes(x= debulking))+
  geom_bar()+
  theme_minimal(base_size = 14)+
  labs(title = "Frontline treatment")+
  coord_flip()

Frontline %>%
  ggplot(aes(x= imp_debulking))+
  geom_bar()+
  theme_minimal(base_size = 14)+
  labs(title = "Frontline treatment")+
  coord_flip()

Frontline %>%
  ggplot(aes(x= raceeth, fill= debulking))+
  geom_bar(position ="fill")+
  theme_minimal(base_size = 14)+
  labs(title = "Frontline treatment")+
  coord_flip()

Frontline %>%
  ggplot(aes(x= raceeth, fill= imp_debulking))+
  geom_bar(position ="fill")+
  theme_minimal(base_size = 14)+
  labs(title = "Frontline treatment")+
  coord_flip()

full_data_study_pop %>% 
  filter(linenumber_adj == 1) %>% 
  distinct(patientid, chemotherapy_type, .keep_all = TRUE) %>% 
  ggplot(aes(x= linename, fill= therapy))+
  geom_bar(aes(fill = therapy), position = position_dodge(preserve = "single"))+
  theme_minimal(base_size = 14) + 
  facet_wrap(bmi_cat ~ chemotherapy_type)+
  coord_flip()

full_data_study_pop %>% 
  filter(chemotherapy_type == "Neoadjuvant") %>% 
  group_by(patientid, drugname) %>% 
  summarise(CrCl = mean(CrCl),
            target_auc = mean(target_auc),
            expected_dose = mean(expected_dose)) %>% 
  ungroup() %>% 
  distinct(patientid, drugname, .keep_all = TRUE) %>% 
  select(CrCl, target_auc, expected_dose, drugname) %>% 
  tbl_summary(by = drugname,
              label = list(CrCl ~ "Average CrCl during Neoadujant setting",
                           target_auc ~ "Target dose (AUC or mg/mg2)",
                           expected_dose ~ "Expected dose")
    )
```
</div>
</div>

<br>

## 3.Survivals by treatment

<div class = "row">
<div class = "col-md-6">
```{r treatment survival, fig.height = 7}
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ 1, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ debulking, data=Frontline %>%
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of diagnosis",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ imp_debulking, data=Frontline %>%
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of diagnosis",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))

# OS by therapy
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ therapy, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 1))
```
</div>

<div class = "col-md-6">
```{r, fig.height = 7}
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ 1, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of from first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ debulking, data=Frontline %>%
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of from first treatment",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ imp_debulking, data=Frontline %>%
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of from first treatment",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))


# OS by therapy
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ therapy, data=Frontline %>% 
                     distinct(patientid, .keep_all = TRUE)),
           title = "OS from date of from first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 1))
```
</div>
</div>

<br>
<br>

***

<br>


# III.RDI
RDI is calculated by drug so 1 for each Carboplatin, Cisplatin, Oxaloplatin, Paclitaxel, Paclitaxel protein bound, Docetaxel.  

```{r echo=TRUE}
# RDI_grp = case_when(
#     mean_RDI_per_drug >= 0.85              ~ "correct",
#     mean_RDI_per_drug < 0.85               ~ "underdose"
#   ))
```
Start with plotting : 

## 1.Plots RDI

<div class = "row">
<div class = "col-md-6">
```{r rdi plots, fig.height=10, fig.height=9}
Frontline %>% 
  pivot_longer(cols = c(RDI_carbo_neo, RDI_pacli_neo, RDI_carbo_adj, RDI_pacli_adj)) %>% 
  filter(!is.na(value)) %>% 
  ggplot(aes(x= name))+
  geom_bar(aes(fill = therapy), position = position_dodge(preserve = "single"))+
  theme_minimal(base_size = 14)+
  coord_flip()

Frontline %>% 
  pivot_longer(cols = c(RDI_carbo_neo, RDI_pacli_neo, RDI_carbo_adj, RDI_pacli_adj)) %>% 
  filter(!is.na(value)) %>% 
  ggplot(aes(x= name, y= value))+
  geom_boxplot()+
  # ylim(c(-.25, 3.5))+
  geom_jitter(shape=16)+
  labs(x = "", caption = "Warning 1 dot = RDI for 1 patient") +
  theme_minimal(base_size = 14)+
  coord_flip()+
  facet_wrap(.~ therapy, ncol = 2)
```
</div>

<div class = "col-md-6">
```{r, fig.height=10, fig.height=9}
# Frontline %>%
#   select(patientid, RDI_carbo_neo, RDI_pacli_neo, RDI_carbo_adj, RDI_pacli_adj,
#          RDI_carbo_neo_grp, RDI_pacli_neo_grp, RDI_carbo_adj_grp, RDI_pacli_adj_grp) %>%
#   pivot_longer(cols = -patientid, names_to = c("RDI", "group"), names_prefix = "_grp")
#   filter(!is.na(value)) %>%
#   ggplot(aes(x= name))+
#   geom_bar(aes(fill = therapy, alpha = RDI_grp), position = position_dodge(preserve = "single"))+
#   theme_minimal(base_size = 14)+
# coord_flip()
# 
Frontline %>% 
  pivot_longer(cols = c(RDI_carbo_neo, RDI_pacli_neo, RDI_carbo_adj, RDI_pacli_adj)) %>% 
  filter(!is.na(value)) %>% 
  ggplot(aes(x= name, y= value, color= value < 0.85))+
  geom_boxplot()+
  geom_jitter(shape=16)+
  labs(x = "", caption = "Warning 1 dot = RDI for 1 patient") +
  theme_minimal(base_size = 14)+
  coord_flip()+
  facet_wrap(.~ therapy, ncol = 2)
```
</div>
</div>

```{r}
# Frontline %>% filter(!is.na(mean_RDI_per_drug)) %>%
#   ggplot(aes(x= drugname, fill = RDI_grp))+
#   geom_bar(position = "fill")+
#   theme_minimal(base_size = 14)+
#   facet_wrap(.~ therapy)+
#   coord_flip()
```

### By Population
```{r, fig.width=12, fig.height=20}
Frontline %>% 
  pivot_longer(cols = c(RDI_carbo_neo, RDI_pacli_neo, RDI_carbo_adj, RDI_pacli_adj)) %>% 
  filter(!is.na(value)) %>% 
  ggplot(aes(x= raceeth))+
  geom_bar(aes(fill = therapy), position = position_dodge(preserve = "single"))+
  theme_minimal(base_size = 14)+
  coord_flip()+
  facet_wrap(name ~ ., ncol = 1, scales = "free")
```

```{r ggridges, fig.width=16, fig.height=18}
library(ggridges)
Frontline %>% 
  pivot_longer(cols = c(RDI_carbo_neo, RDI_pacli_neo, RDI_carbo_adj, RDI_pacli_adj)) %>% 
  filter(!is.na(value)) %>% 
  ggplot(aes(y=raceeth, x=value,  fill=raceeth
             )) +
    geom_density_ridges(alpha=0.5) +
    theme_ridges()+
  theme(#text = element_text(size = 14),#axis.text.y = element_blank(),
        panel.spacing = unit(0.1, "lines"),
        strip.text.x = element_text(size = 14)
    ) +
  geom_vline(xintercept = 1, color = "red", linetype = 2)+

  facet_wrap(therapy ~ name, ncol = 2, scales = "free_x")

Frontline %>% 
  pivot_longer(cols = c(RDI_carbo_neo, RDI_pacli_neo, RDI_carbo_adj, RDI_pacli_adj)) %>% 
  filter(!is.na(value)) %>% 
  ggplot(aes(y=bmi_cat, x=value,  fill=bmi_cat
             )) +
    geom_density_ridges(alpha=0.5) +
    theme_ridges()+
  theme(#text = element_text(size = 14),#axis.text.y = element_blank(),
        panel.spacing = unit(0.1, "lines"),
        strip.text.x = element_text(size = 14)
    ) +
  geom_vline(xintercept = 1, color = "red", linetype = 2)+

  facet_wrap(therapy ~ name, ncol = 2, scales = "free_x")
```



## 1.RDI summary table

<span style="color:green">**Table 6: RDI summary table**</span>  

```{r}
my_theme <-
  list(
    # Some gt customization
    "as_gt-lst:addl_cmds" = list(
      # make the font size small
      tab_spanner = rlang::expr(gt::tab_options(row.striping.background_color = "lightgrey",
                                                row.striping.include_stub = TRUE,
                                                row.striping.include_table_body = TRUE,
                                                row_group.border.top.color = "blue",
                                                # table.background.color = "white", 
                                                heading.background.color = "lightblue", 
                                                # column_labels.background.color = "orange", 
                                                row_group.background.color = "grey",
                                                stub.background.color = "slateblue", 
                                                summary_row.background.color = "tomato", 
                                                grand_summary_row.background.color = "green")),
      # add a custom title and subtitle to every table
      # user_added1 = rlang::expr(gt::tab_header(
      #   title = "Christelle's Table", subtitle = "Yeap"))#,
      # add a custom data source note
      # user_added2 = rlang::expr(gt::tab_source_note(
      #   source_note = "Source: our data!"))#,
      # stripe the table rows
      user_added1 = rlang::expr(gt::opt_row_striping())#,
      # user_added4 = rlang::expr(gt::opt_table_lines("none"))
      )
    )

reset_gtsummary_theme()
set_gtsummary_theme(my_theme)


# trial %>%
#   select(age, grade, trt) %>%
#   tbl_summary(by = trt) %>%
#   add_stat_label() %>%
#   add_p() %>%
#   as_gt() 
```


```{r Table summary Platin}
# Treatment & demo
tbl1 <- Frontline %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c("RDI (continous)" = RDI_carbo_neo, "RDI (categorical)" = RDI_carbo_neo_grp, therapy)) %>%
  tbl_summary(by = therapy) %>% 
  bold_labels() %>% add_n() %>% add_overall()

tbl2 <- Frontline %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c("RDI (continous)" = RDI_carbo_adj, "RDI (categorical)" = RDI_carbo_adj_grp, therapy)) %>%
  tbl_summary(by = therapy) %>%
  bold_labels() %>% add_n() %>% add_overall()

tbl3 <- Frontline %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c("RDI (continous)" = RDI_pacli_neo, "RDI (categorical)" = RDI_pacli_neo_grp, therapy)) %>%
  tbl_summary(by = therapy
              ) %>%
  bold_labels() %>% add_n() %>% add_overall()

tbl4 <- Frontline %>% 
  distinct(patientid, .keep_all = TRUE) %>%
  select(c("RDI (continous)" = RDI_pacli_adj, "RDI (categorical)" = RDI_pacli_adj_grp, therapy)) %>%
  tbl_summary(by = therapy
              ) %>%
  bold_labels() %>% add_n() %>% add_overall()
tbl5 <- Frontline %>% filter(dose_dense == 3) %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c("RDI (continous)" = RDI_pacli_neo, "RDI (categorical)" = RDI_pacli_neo_grp, therapy)) %>%
  tbl_summary(by = therapy,
              type = list(`RDI (continous)` ~ "continuous")) %>%
  bold_labels() %>% add_n() %>% add_overall()
tbl6 <- Frontline %>% filter(dose_dense == 3) %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c("RDI (continous)" = RDI_pacli_adj, "RDI (categorical)" = RDI_pacli_adj_grp, therapy)) %>%
  tbl_summary(by = therapy,
              type = list(`RDI (continous)` ~ "continuous")) %>%
  bold_labels() %>% add_n() %>% add_overall()

# tbl4 <- tbl_merge(list(tbl4_1, tbl4_2)) %>%
#   modify_spanning_header(everything() ~ NA_character_)
tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5, tbl6),
          group_header = c(
                           "Carboplatin Neo", 
                           "Carboplatin Adj",
                           "Paclitaxel overall Neo",
                           "Paclitaxel overall Adj",
                           "Paclitaxel dose dense Neo",
                           "Paclitaxel dose dense Adj"),
          quiet = TRUE)
```

```{r}
# reset_gtsummary_theme()
```

```{r Table summary Taxanes}
# tbl1 <- Frontline %>% filter(therapy == "Upfront Chemo") %>%
#   distinct(patientid, .keep_all = TRUE) %>%
#   select(c(RDI_carbo_neo, RDI_carbo_neo_grp, therapy)) %>%
#   tbl_summary(by = therapy) %>% 
#   bold_labels()
# 
# tbl2 <- Frontline %>% filter(therapy == "Upfront Chemo") %>%
#   distinct(patientid, .keep_all = TRUE) %>%
#   select(c(RDI_carbo_adj, RDI_carbo_adj_grp, therapy)) %>%
#   tbl_summary(by = therapy) %>%
#   bold_labels()
# tbl4 <- tbl_stack(list(tbl1, tbl2),
#           group_header = c(
#                            "paclitaxel Neo/Upfront Chemo",
#                            "paclitaxel Adj/Upfront Chemo"),
#           quiet = TRUE)
# 
# 
# tbl3 <- Frontline %>% filter(therapy == "Upfront Surgery") %>%
#   distinct(patientid, .keep_all = TRUE) %>%
#   select(c(RDI_carbo_adj, RDI_carbo_adj_grp, therapy)) %>%
#   tbl_summary(by = therapy) %>%
#   bold_labels()
# tbl_merge(list(tbl4, tbl3), tab_spanner = c("Overall", "Dose dense 1+3"))





####
# tbl4 <- Frontline %>% filter(therapy == "Upfront Chemo" &
#                                dose_dense == 3) %>%
#   distinct(patientid, .keep_all = TRUE) %>%
#   select(c("RDI" = RDI_pacli_neo, "RDI cat" = RDI_pacli_neo_grp)) %>%
#   tbl_summary() %>%
#   bold_labels()

# tbl5 <- Frontline %>% filter(therapy == "Upfront Chemo" &
#                                dose_dense == 3) %>%
#   distinct(patientid, .keep_all = TRUE) %>%
#   select(c("RDI" = RDI_pacli_adj, "RDI cat" = RDI_pacli_adj_grp)) %>%
#   tbl_summary() %>%
#   bold_labels()
# tbl6 <- Frontline %>% filter(therapy == "Upfront Surgery" &
#                                dose_dense == 3) %>%
#   distinct(patientid, .keep_all = TRUE) %>%
#   select(c("RDI" = RDI_pacli_adj, "RDI cat" = RDI_pacli_adj_grp)) %>%
#   tbl_summary(
#               type = list(RDI ~ "continuous")) %>%
#   bold_labels()

# tbl8 <- tbl_merge(list(tbl2, tbl4))
# tbl9 <- tbl_merge(list(tbl3, tbl6), tab_spanner = c("Overall", "Dose dense 1+3"))

# tbl_stack(list(tbl1, tbl2, tbl3, tbl6),
#           group_header = c(
#                            "paclitaxel Neo/Upfront Chemo", 
#                            "paclitaxel Adj/Upfront Chemo",
#                            "paclitaxel Adj/Upfront Surgery",
#                            "dose dense paclitaxel Adj/Upfront Surgery"),
#           quiet = TRUE)
```
<br>







<span style="color:green">**Table 7: Summary RDI data by race and bmi**</span>  
Removing the overall on the right side? Or do you want the tables separated?
Platin  
```{r Table4 summary Platin}
tbl1 <- Frontline %>% filter(therapy == "Upfront Chemo") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(raceeth, "RDI" = RDI_carbo_neo, "RDI cat" = RDI_carbo_neo_grp)) %>%
  tbl_summary(by = raceeth) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)
tbl2 <- Frontline %>% filter(therapy == "Upfront Chemo") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(bmi_cat, "RDI" = RDI_carbo_neo, "RDI cat" = RDI_carbo_neo_grp)) %>%
  tbl_summary(by = bmi_cat) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)

tbl3 <- Frontline %>% filter(therapy == "Upfront Chemo") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(raceeth, "RDI" = RDI_carbo_adj, "RDI cat" = RDI_carbo_adj_grp)) %>%
  tbl_summary(by = raceeth) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)
tbl4 <- Frontline %>% filter(therapy == "Upfront Chemo") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(bmi_cat, "RDI" = RDI_carbo_adj, "RDI cat" = RDI_carbo_adj_grp)) %>%
  tbl_summary(by = bmi_cat) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)

tbl5 <- Frontline %>% filter(therapy == "Upfront Surgery") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(raceeth, "RDI" = RDI_carbo_adj, "RDI cat" = RDI_carbo_adj_grp)) %>%
  tbl_summary(by = raceeth) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)
tbl6 <- Frontline %>% filter(therapy == "Upfront Surgery") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(bmi_cat, "RDI" = RDI_carbo_adj, "RDI cat" = RDI_carbo_adj_grp)) %>%
  tbl_summary(by = bmi_cat) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)

tbl7 <-
  tbl_merge(list(tbl1, tbl2), tab_spanner = c("Race/Ethnicity", "BMI"))
tbl8 <-
  tbl_merge(list(tbl3, tbl4))
tbl9 <-
  tbl_merge(list(tbl6, tbl6))

tbl_stack(list(tbl7, tbl8, tbl9),
          group_header = c(
                           "carboplatin Neo/Upfront Chemo", 
                           "carboplatin Adj/Upfront Chemo",
                           "carboplatin Adj/Upfront Surgery"),
          quiet = TRUE)
```
<br>

Taxanes
```{r Table4 summary Taxanes}
tbl1 <- Frontline %>% filter(therapy == "Upfront Chemo") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(raceeth, "RDI" = RDI_pacli_neo, "RDI cat" = RDI_pacli_neo_grp)) %>%
  tbl_summary(by = raceeth) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)
tbl2 <- Frontline %>% filter(therapy == "Upfront Chemo") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(bmi_cat, "RDI" = RDI_pacli_neo, "RDI cat" = RDI_pacli_neo_grp)) %>%
  tbl_summary(by = bmi_cat) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)

tbl3 <- Frontline %>% filter(therapy == "Upfront Chemo") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(raceeth, "RDI" = RDI_pacli_adj, "RDI cat" = RDI_pacli_adj_grp)) %>%
  tbl_summary(by = raceeth) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)
tbl4 <- Frontline %>% filter(therapy == "Upfront Chemo") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(bmi_cat, "RDI" = RDI_pacli_adj, "RDI cat" = RDI_pacli_adj_grp)) %>%
  tbl_summary(by = bmi_cat) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)

tbl5 <- Frontline %>% filter(therapy == "Upfront Surgery") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(raceeth, "RDI" = RDI_pacli_adj, "RDI cat" = RDI_pacli_adj_grp)) %>%
  tbl_summary(by = raceeth) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)
tbl6 <- Frontline %>% filter(therapy == "Upfront Surgery") %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(c(bmi_cat, "RDI" = RDI_pacli_adj, "RDI cat" = RDI_pacli_adj_grp)) %>%
  tbl_summary(by = bmi_cat) %>%
  bold_labels() %>% 
  add_p() %>% bold_p(t= 0.05)

tbl7 <-
  tbl_merge(list(tbl1, tbl2), tab_spanner = c("Race/Ethnicity", "BMI"))
tbl8 <-
  tbl_merge(list(tbl3, tbl4))
tbl9 <-
  tbl_merge(list(tbl6, tbl6))

tbl_stack(list(tbl7, tbl8, tbl9),
          group_header = c(
                           "paclitaxel Neo/Upfront Chemo", 
                           "paclitaxel Adj/Upfront Chemo",
                           "paclitaxel Adj/Upfront Surgery"),
          quiet = TRUE)
```
<br>
<br>

***

<br>

## 3.Survivals by RDI

### Survivals RDI by chemotherapy type
<div class = "row">
<div class = "col-md-6">
```{r OS dx RDI, fig.height = 7}
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ RDI_carbo_neo_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Chemo") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis carboplatin \nUpfront Chemo",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ RDI_carbo_adj_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Chemo") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis carboplatin \nUpfront Chemo",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ RDI_carbo_adj_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Surgery") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis carboplatin \nUpfront Surgery",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ RDI_pacli_neo_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Chemo") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis paclitaxel \nUpfront Chemo",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ RDI_pacli_adj_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Chemo") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis paclitaxel \nUpfront Chemo",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ RDI_pacli_adj_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Surgery") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis paclitaxel \nUpfront Surgery",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))
```
</div>

<div class = "col-md-6">
```{r OS treatment RDI, fig.height = 7}
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_carbo_neo_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Chemo") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis carboplatin \nUpfront Chemo",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_carbo_adj_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Chemo") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis carboplatin \nUpfront Chemo",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_carbo_adj_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Surgery") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis carboplatin \nUpfront Surgery",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_pacli_neo_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Chemo") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis paclitaxel \nUpfront Chemo",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_pacli_adj_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Chemo") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis paclitaxel \nUpfront Chemo",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))

ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_pacli_adj_grp, 
                   data=Frontline %>% 
                     filter(therapy == "Upfront Surgery") %>%
                     distinct(patientid, .keep_all = TRUE)
                   ),
           title = "OS from diagnosis paclitaxel \nUpfront Surgery",
           font.main = c(24, "bold", "black"),
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"),
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"),
           size = 1.5,

           pval=TRUE,
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"),
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),

           legend.title = "", xlab = "Time (in months)"
) + guides(colour = guide_legend(ncol = 1))
```
</div>
</div>

<br>
<br>

***

# IV.Hazard Ratio

<span style="color:green">**Table 8 HR Univariable**</span>  

## Univariable
```{r Table 6 HR}
# tbl2 <- Frontline %>%
#   filter(therapy == "Upfront Chemo")
# tbl1 <- tbl2 %>%
#   select(vitalstatus, RDI_carbo_neo, RDI_carbo_neo_grp) %>% 
#   tbl_uvregression(method = survival::coxph,
#                  y = (Surv(time = tbl2$month_at_os_from_treatment, event = tbl2$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") %>% 
#   add_
# tbl2 <- tbl2 %>%
#   select(vitalstatus, RDI_carbo_adj, RDI_carbo_adj_grp) %>% 
#   tbl_uvregression(method = survival::coxph,
#                  y = (Surv(time = tbl2$month_at_os_from_treatment, event = tbl2$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# 
# 
# tbl3 <- Frontline %>%
#   filter(therapy == "Upfront Surgery")
# tbl3 <- tbl3 %>%
#   select(vitalstatus, RDI_carbo_adj, RDI_carbo_adj_grp) %>% 
#   tbl_uvregression(method = survival::coxph,
#                  y = (Surv(time = tbl3$month_at_os_from_treatment, event = tbl3$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl5 <- tbl_merge(list(tbl2, tbl3))
# 
# # tbl4 <- tbl_merge(list(tbl4_1, tbl4_2)) %>%
# #   modify_spanning_header(everything() ~ NA_character_)
# 
# tbl_stack(list(tbl1, tbl5)) %>%
#   bold_labels() %>%
#   italicize_levels()

  # trial %>%
  # select(age, grade, stage, trt) %>%
  # mutate(grade = paste("Grade", grade)) %>%
  # # tbl_strata(
  # #   strata = grade,
  # #   .tbl_fun =
  # #     ~ .x %>%
  #       tbl_summary(by = trt, missing = "no") %>%
  #       add_n()
  # )




tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- tbl2 %>%
  select(vitalstatus, RDI_carbo_neo, RDI_carbo_neo_grp) %>% 
  tbl_uvregression(method = survival::coxph,
                 y = (Surv(time = tbl2$month_at_os_from_treatment, event = tbl2$vitalstatus)),
                 exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- tbl2 %>%
  select(vitalstatus, RDI_carbo_adj, RDI_carbo_adj_grp) %>% 
  tbl_uvregression(method = survival::coxph,
                 y = (Surv(time = tbl2$month_at_os_from_treatment, event = tbl2$vitalstatus)),
                 exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- tbl3 %>%
  select(vitalstatus, RDI_carbo_adj, RDI_carbo_adj_grp) %>% 
  tbl_uvregression(method = survival::coxph,
                 y = (Surv(time = tbl3$month_at_os_from_treatment, event = tbl3$vitalstatus)),
                 exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("carboplatin Neo/Upfront Chemo", 
                           "carboplatin Adj/Upfront Chemo",
                           "carboplatin Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()

# Pacli

tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- tbl2 %>%
  select(vitalstatus, RDI_pacli_neo, RDI_pacli_neo_grp) %>% 
  tbl_uvregression(method = survival::coxph,
                 y = (Surv(time = tbl2$month_at_os_from_treatment, event = tbl2$vitalstatus)),
                 exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- tbl2 %>%
  select(vitalstatus, RDI_pacli_adj, RDI_pacli_adj_grp) %>% 
  tbl_uvregression(method = survival::coxph,
                 y = (Surv(time = tbl2$month_at_os_from_treatment, event = tbl2$vitalstatus)),
                 exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- tbl3 %>%
  select(vitalstatus, RDI_pacli_adj, RDI_pacli_adj_grp) %>% 
  tbl_uvregression(method = survival::coxph,
                 y = (Surv(time = tbl3$month_at_os_from_treatment, event = tbl3$vitalstatus)),
                 exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("paclitaxel/Upfront Chemo", 
                           "paclitaxel/Upfront Chemo",
                           "paclitaxel/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```

<br>
<br>

## Multivariable
### RDI group
<span style="color:green">**Table 9 HR Multivariable**</span>  

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~RDI_grp + raceeth + ageatdx + imp_stagecat + histology + imp_debulking` 
```{r Table 5 HR adjusted rdi group}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo_grp + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_adj_grp + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj_grp + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("carboplatin Neo/Upfront Chemo", 
                           "carboplatin Adj/Upfront Chemo",
                           "carboplatin Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()

# Pacli

tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_neo_grp + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_adj_grp + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_pacli_adj_grp + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("paclitaxel Neo/Upfront Chemo", 
                           "paclitaxel Adj/Upfront Chemo",
                           "paclitaxel Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~RDI_grp + raceeth + ageatdx + imp_stagecat + histology` 
```{r}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo_grp + raceeth + ageatdx + imp_stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_adj_grp + raceeth + ageatdx + imp_stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj_grp + raceeth + ageatdx + imp_stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("carboplatin Neo/Upfront Chemo", 
                           "carboplatin Adj/Upfront Chemo",
                           "carboplatin Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()

# Pacli

tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_neo_grp + raceeth + ageatdx + imp_stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_adj_grp + raceeth + ageatdx + imp_stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_pacli_adj_grp + raceeth + ageatdx + imp_stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("paclitaxel Neo/Upfront Chemo", 
                           "paclitaxel Adj/Upfront Chemo",
                           "paclitaxel Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```
<!-- In multivariable analysis, categorical RDI for carboplatin or paclitaxel is not a factor associated with survival. -->

<br>
<br>

### Continous
<span style="color:green">**Table 10 HR Multivariable**</span>  

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~ mean_RDI_per_drug + raceeth + ageatdx + imp_stagecat + histology + imp_debulking` 
```{r rdi continous}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_adj + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("carboplatin Neo/Upfront Chemo", 
                           "carboplatin Adj/Upfront Chemo",
                           "carboplatin Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()

# Pacli

tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_neo + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_adj + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_pacli_adj + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("paclitaxel Neo/Upfront Chemo", 
                           "paclitaxel Adj/Upfront Chemo",
                           "paclitaxel Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~ mean_RDI_per_drug + raceeth + ageatdx + imp_stagecat + histology` 
```{r}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo + raceeth + ageatdx + imp_stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_adj + raceeth + ageatdx + imp_stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj + raceeth + ageatdx + imp_stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("carboplatin Neo/Upfront Chemo", 
                           "carboplatin Adj/Upfront Chemo",
                           "carboplatin Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()

# Pacli

tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_neo + raceeth + ageatdx + imp_stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_adj + raceeth + ageatdx + imp_stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_pacli_adj + raceeth + ageatdx + imp_stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("paclitaxel Neo/Upfront Chemo", 
                           "paclitaxel Adj/Upfront Chemo",
                           "paclitaxel Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```
<!-- In multivariable analysis, a higher RDI for carboplatin shows a worse survival (p<0.001) in an Adjuvant / Upfront Chemo setting as seen in the univariable analysis.   -->
<!-- RDI for paclitaxel is not a factor associated with survival. -->

<br>
<br>

## Adjusted by other drug
### RDI group
<span style="color:green">**Table 11 HR Multivariable**</span>  

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~ RDI_carbo_neo_grp + RDI_pacli_neo_grp + RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + imp_stagecat + histology + imp_debulking` 
```{r Table 5 HR adjusted rdi group adjusted by other drug}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo_grp + RDI_pacli_neo_grp + RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl2, tbl3),
          group_header = c("Upfront Chemo", "Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~ RDI_carbo_neo_grp + RDI_pacli_neo_grp + RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + imp_stagecat + histology` 
```{r}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo_grp + RDI_pacli_neo_grp + RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + imp_stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + imp_stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl2, tbl3),
          group_header = c("Upfront Chemo", "Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```
<!-- When adjusting by each drugs, we observe a 61% increased risk of death for a underdosing of carboplatin in the Neoadjuvant / Upfront Chemo setting (p=0.059) and a 32% increased risk of death for a underdosing of paclitaxel in the Adjuvant / Upfront Surgery setting (p=0.059). -->

<br>
<br>

### Continous
<span style="color:green">**Table 12 HR Multivariable**</span>  

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus) ~ RDI_carbo_neo + RDI_pacli_neo + RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + imp_stagecat + histology + imp_debulking` 
```{r rdi continous adjusted by other drug}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo + RDI_pacli_neo + RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + imp_stagecat + histology + imp_debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl2, tbl3),
          group_header = c("Upfront Chemo", "Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus) ~ RDI_carbo_neo + RDI_pacli_neo + RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + histology` 
```{r}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo + RDI_pacli_neo + RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + imp_stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + imp_stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl2, tbl3),
          group_header = c("Upfront Chemo", "Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```
<!-- Continuous RDI for carboplatin or paclitaxel are not factors associated with survival. -->

<br>
<br>

***

<br>

<!-- # V.More precise RDI -->

<!-- As you saw, we have a big spread of RDI (it is more complicated than < or > 0.85) so I thought I could make more than 2 groups to compare patients who have a correct RDI, being underdosed or overdosed -->

<!-- ```{r echo=TRUE} -->
<!-- # Highly underdosed: < 0.75 -->
<!-- # Underdosed: >= 0.75 to <0.85 -->
<!-- # Adequate dosing: >= 0.85 to <1.10 -->
<!-- # Overdosing: >=1.10 -->
<!-- ``` -->
<!-- Fun to see the dots for underdosed patients being located on the right side (higher BMI) and dots for overdosed located on the left (lower BMI) -->
<!-- ```{r, fig.width=12, fig.height=12} -->
<!-- Frontline %>% filter(!is.na(mean_RDI_per_drug)) %>% -->
<!--   ggplot(aes(x= bmi_at_dx, y = mean_RDI_per_drug, color= RDI_grp1))+ -->
<!--   geom_point(alpha = 0.7, size = 0.75)+ -->
<!--   theme_minimal(base_size = 10)+ -->
<!--   facet_wrap(drugname~ therapy, ncol = 2, scales = "free") -->
<!-- Frontline %>% filter(!is.na(mean_RDI_per_drug)) %>% -->
<!--   ggplot(aes(x= bmi_cat, y = mean_RDI_per_drug, color= RDI_grp1))+ -->
<!--   geom_jitter()+ -->
<!--   theme_minimal(base_size = 10)+ -->
<!--   facet_wrap(drugname~ therapy, ncol = 2, scales = "free") -->

<!-- ``` -->
<!-- Here I just wanted to see if we have more or less underdosing / overdosing with BMI -->
<!-- ```{r, fig.width=12, fig.height=12} -->
<!-- Frontline %>% filter(!is.na(mean_RDI_per_drug)) %>% -->
<!--   ggplot(aes(x= RDI_grp1, fill = drugname))+ -->
<!--   geom_bar(position = position_dodge())+ -->
<!--   theme_minimal(base_size = 10)+ -->
<!--   facet_wrap(. ~ therapy, ncol = 2, scales = "free")+ -->
<!--   coord_flip() -->
<!-- ``` -->

<!-- ```{r, fig.width=12} -->
<!-- # Frontline %>% filter(!is.na(mean_RDI_per_drug)) %>% -->
<!-- #   ggplot(aes(x= drugname, fill = RDI_grp1))+ -->
<!-- #   geom_bar(position = position_dodge())+ -->
<!-- #   theme_minimal(base_size = 10)+ -->
<!-- #   facet_wrap(drugname ~ chemotherapy_type, ncol = 2, scales = "free")+ -->
<!-- #   coord_flip() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- Frontline %>% filter(!is.na(mean_RDI_per_drug)) %>% -->
<!--   # filter(linenumber_new == "1") %>% -->
<!--   ggplot(aes(x= drugname, fill = RDI_grp1))+ -->
<!--   geom_bar(position = "fill")+ -->
<!--   theme_minimal(base_size = 10)+ -->
<!--   coord_flip()+ -->
<!--   facet_wrap(.~ therapy) -->
<!-- ``` -->
<!-- As you can see above in green, we have a lot of patient who are overdose. -->
<!-- <br> -->
<!-- <br> -->



<!-- ## Hazard Ratio RDI 2 -->

<!-- <span style="color:green">**Table HR**</span> -->

<!-- ### Univariable -->
<!-- ```{r HR RDI 2} -->
<!-- tbl2 <- Frontline %>% -->
<!--   filter(therapy == "Upfront Chemo") -->
<!-- tbl1 <- tbl2 %>% -->
<!--   select(vitalstatus, RDI_carbo_neo, RDI_carbo_neo_grp1) %>%  -->
<!--   tbl_uvregression(method = survival::coxph, -->
<!--                  y = (Surv(time = tbl2$month_at_os_from_treatment, event = tbl2$vitalstatus)), -->
<!--                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl2 <- tbl2 %>% -->
<!--   select(vitalstatus, RDI_carbo_adj, RDI_carbo_adj_grp1) %>%  -->
<!--   tbl_uvregression(method = survival::coxph, -->
<!--                  y = (Surv(time = tbl2$month_at_os_from_treatment, event = tbl2$vitalstatus)), -->
<!--                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl3 <- Frontline %>% -->
<!--   filter(therapy == "Upfront Surgery") -->
<!-- tbl3 <- tbl3 %>% -->
<!--   select(vitalstatus, RDI_carbo_adj, RDI_carbo_adj_grp1) %>%  -->
<!--   tbl_uvregression(method = survival::coxph, -->
<!--                  y = (Surv(time = tbl3$month_at_os_from_treatment, event = tbl3$vitalstatus)), -->
<!--                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl_stack(list(tbl1, tbl2, tbl3), -->
<!--           group_header = c("carboplatin Neo/Upfront Chemo",  -->
<!--                            "carboplatin Adj/Upfront Chemo", -->
<!--                            "carboplatin Adj/Upfront Surgery")) %>% -->
<!--   bold_labels() %>% -->
<!--   italicize_levels() -->

<!-- # Pacli -->

<!-- tbl2 <- Frontline %>% -->
<!--   filter(therapy == "Upfront Chemo") -->
<!-- tbl1 <- tbl2 %>% -->
<!--   select(vitalstatus, RDI_pacli_neo, RDI_pacli_neo_grp1) %>%  -->
<!--   tbl_uvregression(method = survival::coxph, -->
<!--                  y = (Surv(time = tbl2$month_at_os_from_treatment, event = tbl2$vitalstatus)), -->
<!--                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl2 <- tbl2 %>% -->
<!--   select(vitalstatus, RDI_pacli_adj, RDI_pacli_adj_grp1) %>%  -->
<!--   tbl_uvregression(method = survival::coxph, -->
<!--                  y = (Surv(time = tbl2$month_at_os_from_treatment, event = tbl2$vitalstatus)), -->
<!--                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl3 <- Frontline %>% -->
<!--   filter(therapy == "Upfront Surgery") -->
<!-- tbl3 <- tbl3 %>% -->
<!--   select(vitalstatus, RDI_pacli_adj, RDI_pacli_adj_grp1) %>%  -->
<!--   tbl_uvregression(method = survival::coxph, -->
<!--                  y = (Surv(time = tbl3$month_at_os_from_treatment, event = tbl3$vitalstatus)), -->
<!--                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl_stack(list(tbl1, tbl2, tbl3), -->
<!--           group_header = c("paclitaxel/Upfront Chemo",  -->
<!--                            "paclitaxel/Upfront Chemo", -->
<!--                            "paclitaxel/Upfront Surgery")) %>% -->
<!--   bold_labels() %>% -->
<!--   italicize_levels() -->
<!-- ``` -->
<!-- Overdosing can help survival for carboplatin/Adjuvant Upfront Surgery and paclitaxel/Neoadjuvant ?? Loss it when choose correct as reference. -->

<!-- ### Multivariable -->
<!-- `coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~ RDI_grp1 + raceeth + ageatdx + stagecat` -->
<!-- ```{r} -->
<!-- tbl2 <- Frontline %>% -->
<!--   filter(therapy == "Upfront Chemo") -->
<!-- tbl1 <-  -->
<!--   coxph(Surv(time = tbl2$month_at_os_from_treatment,  -->
<!--              event = tbl2$vitalstatus) ~ RDI_carbo_neo_grp1 + raceeth + ageatdx + stagecat, data =  tbl2) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl2 <-  -->
<!--   coxph(Surv(time = tbl2$month_at_os_from_treatment,  -->
<!--              event = tbl2$vitalstatus) ~ RDI_carbo_adj_grp1 + raceeth + ageatdx + stagecat, data =  tbl2) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl3 <- Frontline %>% -->
<!--   filter(therapy == "Upfront Surgery") -->
<!-- tbl3 <-  -->
<!--   coxph(Surv(time = tbl3$month_at_os_from_treatment,  -->
<!--              event = tbl3$vitalstatus) ~ RDI_carbo_adj_grp1 + raceeth + ageatdx + stagecat, data =  tbl3) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl_stack(list(tbl1, tbl2, tbl3), -->
<!--           group_header = c("carboplatin Neo/Upfront Chemo",  -->
<!--                            "carboplatin Adj/Upfront Chemo", -->
<!--                            "carboplatin Adj/Upfront Surgery")) %>% -->
<!--   bold_labels() %>% -->
<!--   italicize_levels() -->

<!-- # Pacli -->

<!-- tbl2 <- Frontline %>% -->
<!--   filter(therapy == "Upfront Chemo") -->
<!-- tbl1 <-  -->
<!--   coxph(Surv(time = tbl2$month_at_os_from_treatment,  -->
<!--              event = tbl2$vitalstatus) ~ RDI_pacli_neo_grp1 + raceeth + ageatdx + stagecat, data =  tbl2) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl2 <-  -->
<!--   coxph(Surv(time = tbl2$month_at_os_from_treatment,  -->
<!--              event = tbl2$vitalstatus) ~ RDI_pacli_adj_grp1 + raceeth + ageatdx + stagecat, data =  tbl2) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl3 <- Frontline %>% -->
<!--   filter(therapy == "Upfront Surgery") -->
<!-- tbl3 <-  -->
<!--   coxph(Surv(time = tbl3$month_at_os_from_treatment,  -->
<!--              event = tbl3$vitalstatus) ~ RDI_pacli_adj_grp1 + raceeth + ageatdx + stagecat, data =  tbl3) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl_stack(list(tbl1, tbl2, tbl3), -->
<!--           group_header = c("paclitaxel Neo/Upfront Chemo",  -->
<!--                            "paclitaxel Adj/Upfront Chemo", -->
<!--                            "paclitaxel Adj/Upfront Surgery")) %>% -->
<!--   bold_labels() %>% -->
<!--   italicize_levels() -->
<!-- ``` -->
<!-- <br> -->
<!-- <br> -->

<!-- ## Adjusted by other drug -->
<!-- ### RDI group -->
<!-- `coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus) ~ RDI_carbo_neo_grp1 + RDI_pacli_neo_grp1 + raceeth + ageatdx + stagecat` -->
<!-- ```{r Table 5 HR adjusted rdi group adjusted by other drug 2} -->
<!-- tbl2 <- Frontline %>% -->
<!--   filter(therapy == "Upfront Chemo") -->
<!-- tbl2 <-  -->
<!--   coxph(Surv(time = tbl2$month_at_os_from_treatment,  -->
<!--              event = tbl2$vitalstatus) ~ RDI_carbo_neo_grp1 + RDI_pacli_neo_grp1 + RDI_carbo_adj_grp1 + RDI_pacli_adj_grp1 + raceeth + ageatdx + stagecat, data =  tbl2) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl3 <- Frontline %>% -->
<!--   filter(therapy == "Upfront Surgery") -->
<!-- tbl3 <-  -->
<!--   coxph(Surv(time = tbl3$month_at_os_from_treatment,  -->
<!--              event = tbl3$vitalstatus) ~ RDI_carbo_adj_grp1 + RDI_pacli_adj_grp1 + raceeth + ageatdx + stagecat, data =  tbl3) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl_stack(list(tbl2, tbl3), -->
<!--           group_header = c("Upfront Chemo", "Upfront Surgery")) %>% -->
<!--   bold_labels() %>% -->
<!--   italicize_levels() -->
<!-- ``` -->
<!-- <br> -->
<!-- <br> -->

<!-- *** -->

<!-- # VI. Adjusted by **BMI at DX category** -->

<!-- ```{r} -->
<!-- Frontline_bmi <- Frontline %>% -->
<!--   filter(!is.na(bmi_cat)) -->
<!-- ``` -->

<!-- ## Multivariable -->
<!-- `coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~RDI_grp + raceeth + ageatdx + stagecat + bmi_cat` -->
<!-- ```{r bmi HR adjusted} -->
<!-- # Carbo -->
<!-- # tbl1 <- Frontline_bmi %>% -->
<!-- #   filter(drugname == "carboplatin" & chemotherapy_type == "Neoadjuvant") -->
<!-- # tbl1 <- -->
<!-- #   coxph(Surv(time = tbl1$month_at_os_from_treatment, -->
<!-- #              event = tbl1$vitalstatus) ~ RDI_grp + raceeth + ageatdx + stagecat + bmi_cat, data =  tbl1) %>% -->
<!-- #   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") -->

<!-- tbl2 <- Frontline_bmi %>% -->
<!--   filter(drugname == "carboplatin" & therapy == "Upfront Surgery") -->
<!-- tbl2 <- -->
<!--   coxph(Surv(time = tbl2$month_at_os_from_treatment, -->
<!--              event = tbl2$vitalstatus) ~ RDI_grp + raceeth + ageatdx + stagecat + bmi_cat, data =  tbl2) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl3 <- Frontline_bmi %>% -->
<!--   filter(drugname == "carboplatin" & therapy == "Upfront Chemo") -->
<!-- tbl3 <- -->
<!--   coxph(Surv(time = tbl3$month_at_os_from_treatment, -->
<!--              event = tbl3$vitalstatus) ~ RDI_grp + raceeth + ageatdx + stagecat + bmi_cat, data =  tbl3) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl_stack(list(tbl2, tbl3), -->
<!--           group_header = c("carboplatin/Upfront Surgery", "carboplatin/Upfront Chemo")) %>% -->
<!--   bold_labels() %>% -->
<!--   italicize_levels() -->

<!-- # Pacli -->
<!-- # tbl7 <- Frontline_bmi %>% -->
<!-- #   filter(drugname =="paclitaxel" & chemotherapy_type == "Neoadjuvant") -->
<!-- # tbl7 <- -->
<!-- #   coxph(Surv(time = tbl7$month_at_os_from_treatment, -->
<!-- #              event = tbl7$vitalstatus) ~ RDI_grp + raceeth + ageatdx + stagecat + bmi_cat, data =  tbl7) %>% -->
<!-- #   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") -->
<!-- tbl8 <- Frontline_bmi %>% -->
<!--   filter(drugname =="paclitaxel" & therapy == "Upfront Surgery") -->
<!-- tbl8 <- -->
<!--   coxph(Surv(time = tbl8$month_at_os_from_treatment, -->
<!--              event = tbl8$vitalstatus) ~ RDI_grp + raceeth + ageatdx + stagecat + bmi_cat, data =  tbl8) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl9 <- Frontline_bmi %>% -->
<!--   filter(drugname =="paclitaxel" & therapy == "Upfront Chemo") -->
<!-- tbl9 <- -->
<!--   coxph(Surv(time = tbl9$month_at_os_from_treatment, -->
<!--              event = tbl9$vitalstatus) ~ RDI_grp + raceeth + ageatdx + stagecat + bmi_cat, data =  tbl9) %>% -->
<!--   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- tbl_stack(list(tbl8, tbl9), -->
<!--           group_header = c("paclitaxel/Upfront Surgery", "paclitaxel/Upfront Chemo")) %>% -->
<!--   bold_labels() %>% -->
<!--   italicize_levels() -->
<!-- ``` -->

# Complete case HR analysis

## Multivariable
### RDI group
<span style="color:green">**Table 9 HR Multivariable**</span>  

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~RDI_grp + raceeth + ageatdx + stagecat + histology + debulking` 
```{r Table 5 HR adjusted rdi group}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo_grp + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_adj_grp + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj_grp + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("carboplatin Neo/Upfront Chemo", 
                           "carboplatin Adj/Upfront Chemo",
                           "carboplatin Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()

# Pacli

tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_neo_grp + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_adj_grp + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_pacli_adj_grp + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("paclitaxel Neo/Upfront Chemo", 
                           "paclitaxel Adj/Upfront Chemo",
                           "paclitaxel Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~RDI_grp + raceeth + ageatdx + stagecat + histology` 
```{r}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo_grp + raceeth + ageatdx + stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_adj_grp + raceeth + ageatdx + stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj_grp + raceeth + ageatdx + stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("carboplatin Neo/Upfront Chemo", 
                           "carboplatin Adj/Upfront Chemo",
                           "carboplatin Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()

# Pacli

tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_neo_grp + raceeth + ageatdx + stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_adj_grp + raceeth + ageatdx + stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_pacli_adj_grp + raceeth + ageatdx + stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("paclitaxel Neo/Upfront Chemo", 
                           "paclitaxel Adj/Upfront Chemo",
                           "paclitaxel Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```
<!-- In multivariable analysis, categorical RDI for carboplatin or paclitaxel is not a factor associated with survival. -->

<br>
<br>

### Continous
<span style="color:green">**Table 10 HR Multivariable**</span>  

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~ mean_RDI_per_drug + raceeth + ageatdx + stagecat + histology + debulking` 
```{r rdi continous}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_adj + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("carboplatin Neo/Upfront Chemo", 
                           "carboplatin Adj/Upfront Chemo",
                           "carboplatin Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()

# Pacli

tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_neo + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_adj + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_pacli_adj + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("paclitaxel Neo/Upfront Chemo", 
                           "paclitaxel Adj/Upfront Chemo",
                           "paclitaxel Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~ mean_RDI_per_drug + raceeth + ageatdx + stagecat + histology` 
```{r}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo + raceeth + ageatdx + stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_adj + raceeth + ageatdx + stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj + raceeth + ageatdx + stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("carboplatin Neo/Upfront Chemo", 
                           "carboplatin Adj/Upfront Chemo",
                           "carboplatin Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()

# Pacli

tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl1 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_neo + raceeth + ageatdx + stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_pacli_adj + raceeth + ageatdx + stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_pacli_adj + raceeth + ageatdx + stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl1, tbl2, tbl3),
          group_header = c("paclitaxel Neo/Upfront Chemo", 
                           "paclitaxel Adj/Upfront Chemo",
                           "paclitaxel Adj/Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```
<!-- In multivariable analysis, a higher RDI for carboplatin shows a worse survival (p<0.001) in an Adjuvant / Upfront Chemo setting as seen in the univariable analysis.   -->
<!-- RDI for paclitaxel is not a factor associated with survival. -->

<br>
<br>

## Adjusted by other drug
### RDI group
<span style="color:green">**Table 11 HR Multivariable**</span>  

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~ RDI_carbo_neo_grp + RDI_pacli_neo_grp + RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + stagecat + histology + debulking` 
```{r Table 5 HR adjusted rdi group adjusted by other drug}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo_grp + RDI_pacli_neo_grp + RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl2, tbl3),
          group_header = c("Upfront Chemo", "Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus)~ RDI_carbo_neo_grp + RDI_pacli_neo_grp + RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + stagecat + histology` 
```{r}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo_grp + RDI_pacli_neo_grp + RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj_grp + RDI_pacli_adj_grp + raceeth + ageatdx + stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl2, tbl3),
          group_header = c("Upfront Chemo", "Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```
<!-- When adjusting by each drugs, we observe a 61% increased risk of death for a underdosing of carboplatin in the Neoadjuvant / Upfront Chemo setting (p=0.059) and a 32% increased risk of death for a underdosing of paclitaxel in the Adjuvant / Upfront Surgery setting (p=0.059). -->

<br>
<br>

### Continous
<span style="color:green">**Table 12 HR Multivariable**</span>  

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus) ~ RDI_carbo_neo + RDI_pacli_neo + RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + histology + debulking` 
```{r rdi continous adjusted by other drug}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo + RDI_pacli_neo + RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + histology + debulking, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl2, tbl3),
          group_header = c("Upfront Chemo", "Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```

`coxph(Surv(time = month_at_os_from_treatment, event = vitalstatus) ~ RDI_carbo_neo + RDI_pacli_neo + RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + histology` 
```{r}
tbl2 <- Frontline %>%
  filter(therapy == "Upfront Chemo")
tbl2 <- 
  coxph(Surv(time = tbl2$month_at_os_from_treatment, 
             event = tbl2$vitalstatus) ~ RDI_carbo_neo + RDI_pacli_neo + RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + histology, data =  tbl2) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- Frontline %>%
  filter(therapy == "Upfront Surgery")
tbl3 <- 
  coxph(Surv(time = tbl3$month_at_os_from_treatment, 
             event = tbl3$vitalstatus) ~ RDI_carbo_adj + RDI_pacli_adj + raceeth + ageatdx + stagecat + histology, data =  tbl3) %>%
  tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl_stack(list(tbl2, tbl3),
          group_header = c("Upfront Chemo", "Upfront Surgery")) %>%
  bold_labels() %>%
  italicize_levels()
```




```{r echo=FALSE, out.width='30%'}
knitr::include_graphics('/Users/colinccm/Documents/GitHub/Peres/lab_logo/Peres hex.png')
```

