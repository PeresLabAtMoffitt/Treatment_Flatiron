---
title: "Flatiron analysis"
author: "Christelle Colin-Leitzinger"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: flatly
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
.figure {
   margin-top: 25px;
   margin-bottom: 100px;
}

table {
    margin-top: 1px;
    margin-bottom: 25px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      fig.align='center'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```
<br>

***

```{r library, include=FALSE}
library(drake)
library(tidyverse)
library(data.table)
library(lubridate)
library(ggplot2)
library(gtsummary)
library(survminer)
library(survival)
```

```{r loadd}
loadd(drugs)
creatinine <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/creatinine.rds")
weight <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/weight.rds")
height <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/height.rds")
body_surface_area <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/body_surface_area.rds")
areaUC <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/areaUC.rds")
clinical_data <- read_rds("/Users/colinccm/Documents/GitHub/Peres/Treatment_Flatiron/clinical_data.rds")
```

At this point, after cleaning the clinical data and excluding unfit patients, we have `r nrow(clinical_data)` patients.  
- exclude the patients who had surgery but we don't have a date  
- exclude patients whose histology is unknown  
- exclude patients who didn't survive 1 month  

Also height, weight, bsa, creatinine is cleaned and ready. Creatinine minimum is now capped at 0.7 and not 0.8.  
Creatinine clearance maximum is capped at 125.  

Now drug cleaning!

# I. Drug episode questions

**We start with a number of patient who has drug info of `r drugs %>% distinct(patientid) %>% nrow()`.**  


### step 1: Patients with a date of drug or date of surgery BEFORE diagnosis will be excluded
```{r drugs episode cleanup}
drugs1 <- drugs %>% 
  filter(episodedatasource == "Administrations" & 
           ismaintenancetherapy == "FALSE") %>%
  # 1. 60 days rule between diagnosis and treatment # Loss 1
  # bind with clinical
  inner_join(., clinical_data, #%>% select("patientid", "diagnosisdate", "surgerydate"),
          by = "patientid") %>% 
  arrange(patientid, episodedate) %>% 
  group_by(patientid) %>% 
  mutate(first_drug_date = first(episodedate)) %>% 
  mutate(days_at_first_drug = interval(start = diagnosisdate, end = first_drug_date)/
           duration(n=1, units = "months")) %>% 
  mutate(days_at_surg = interval(start = diagnosisdate, end = surgerydate)/
           duration(n=1, units = "months")) %>% 
  ungroup()



```
We have `r drugs1 %>% filter(days_at_first_drug < 0) %>% distinct(patientid) %>% nrow()` patients with date of drug before diagnosis and `r drugs1 %>% filter(days_at_surg < 0) %>% distinct(patientid) %>% nrow()` patients with a date of surgery before diagnosis. Patients left :

```{r}
drugs1 <- drugs1 %>% 
  filter(days_at_first_drug >= 0 &
           (is.na(surgerydate) | days_at_surg >= 0)
         )
drugs1 %>% distinct(patientid) %>% nrow()
```

### step 2: 60 days rule between diagnosis and treatment
60 days rule between diagnosis and treatment to eliminate patients who didn't get treatment for 60 days which could mean they were treated but it is not recorded. Patients left :
```{r}
remove_60daysrule <- drugs1 %>% 
  filter((days_at_first_drug > 60 | days_at_surg > 60)) %>% 
  distinct(patientid)
remove_60daysrule <- paste(remove_60daysrule$patientid, collapse = "|")

drugs1 <- drugs1 %>% 
  # remove these patients who 60 days rule
  filter(!str_detect(patientid, remove_60daysrule))

drugs1 %>% distinct(patientid) %>% nrow()
```

### step 3: 30 days rule excluding patient whith less than 30 days between diagnosis and death
```{r}
drugs1 %>% 
  mutate(thirty_days_exclusion = interval(start = diagnosisdate, end = dateofdeath)/
           duration(n=1, units = "days"), 
         thirty_days_exclusion = case_when(
           thirty_days_exclusion <= 30                  ~ "Exclude"
         )) %>% 
  filter(thirty_days_exclusion == "Exclude") %>% 
  distinct(patientid) %>% 
  nrow

drugs11 <- drugs1 %>% 
  mutate(thirty_days_exclusion = interval(start = diagnosisdate, end = dateofdeath)/
           duration(n=1, units = "days"), 
         thirty_days_exclusion = case_when(
           thirty_days_exclusion <= 30                  ~ "Exclude",
           thirty_days_exclusion > 30                   ~ "Include",
           is.na(dateofdeath)                           ~ "Include"
         )) %>% 
  filter(thirty_days_exclusion != "Exclude")

drugs11 %>% distinct(patientid) %>% nrow()

```
In the data, `r drugs1 %>% mutate(thirty_days_exclusion = interval(start = diagnosisdate, end = dateofdeath)/duration(n=1, units = "days"), thirty_days_exclusion = case_when(thirty_days_exclusion <= 30~ "Exclude")) %>% filter(thirty_days_exclusion == "Exclude") %>% distinct(patientid) %>% nrow` are excluded so we still have `r drugs11 %>% distinct(patientid) %>% nrow()` patients.

### step 3: Remove linename that doesn't include platin or taxels in first line -> later in the process, need first to recode linenumber with all the drugs in.
```{r}
# drugs1 <- drugs1 %>% 
#   # 2. Filtering----
#   filter(episodedatasource == "Administrations" & 
#            # ismaintenancetherapy == "FALSE" & 
#            !is.na(amount) &
#            (days_at_first_drug < 60 | days_at_surg < 60) &
#            
#            days_at_first_drug >= 0 &
#            (is.na(surgerydate) | days_at_surg >= 0)
#          )

drugs1 %>% 
  filter(linenumber == 1) %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  select(linename) %>% 
  tbl_summary(sort = list(everything() ~ "frequency"))
```

### step 4: Combine multiple administrations of the same drug at the same date
```{r combine amount same drug one day}
drugs1 <- drugs1 %>% 
  #When want to remove patients who didn't have taxel/platin as 1st line -> remove 260 patients
  # filter(!(linenumber == 1 & !str_detect(linename, "taxel|platin"))) %>% 
  # filter(str_detect(drugname, "taxel|platin") & str_detect(route, "venous|peritoneal")) %>% ############## LATER------------!!!!!
  select(-c(enhancedcohort, episodedatasource, drugcategory, detaileddrugcategory, route)) %>%
  
  # 3. Combined Multiple Administrations----
  # combined multiple amount of drug given the same day FCF86329BB40C F4E6EE1910940.May be 205 patients row like that
# There are a small number of patients with multiple records in the MedicationAdministration table for the same drug on the same day. We reviewed several instances where this occurs in the original EMR records and found, in each case, legitimate clinical reasons substantiating the multiple administrations per day. Although these instances were legitimate medication administrations, Flatiron Health data are generated from real-world clinical practice and are subject to miscoding and errors by the clinical oncology team, as are all EMR data. Below are three patient vignettes taken from our review of EMR notes, illustrating the variety of reasons why this may occur.
# For clinical reasons, a patient was given higher than normal dose which was listed as two administrations of the normal dose.
# Three administrations of the same drug were listed on a Friday. The EMR note stated that one dose was administered in the office and the patient was sent home with the two remaining doses for the weekend. 
# Patient had an allergic reaction in the past and was administered multiple smaller doses in the same day as part of a desensitization protocol.
  group_by(patientid, linename, linenumber, linestartdate, lineenddate, episodedate, drugname, units, surgerydate, days_at_first_drug, days_at_surg) %>%
  summarise_at(vars(amount), paste, collapse = ";") %>% # don't do sum ti keep the multiple administration in df
  separate(col= amount, paste("amount_", 1:10, sep=""), sep = ";", extra = "warn",
           fill = "right") %>%
  purrr::keep(~!all(is.na(.))) %>%
  ungroup() %>% 
  mutate(amount_1 = as.numeric(amount_1), amount_2 = as.numeric(amount_2),
         amount_3 = as.numeric(amount_3), amount_4 = as.numeric(amount_4)) %>%
  mutate(amount = rowSums(select(.,amount_1:amount_4), na.rm = TRUE)) %>%
  # Found ug, ml, Ea, and NA they are all good, but 
  # ug need conversion
  # the AUC are mostly correct (real mg) but are actual AUC when < at 10 
  mutate(amount =  case_when(
    units == "ug"               ~ amount / 10, # I checked all of them
    units == "AUC" &
      amount < 10               ~ NA_real_,
    TRUE                        ~ amount
  )) %>% 
  
  mutate(drugname_type = case_when(
    str_detect(drugname, "platin")       ~ "platin",
    str_detect(drugname, "taxel")        ~ "taxel"
  ))
```

### step 5: Recode linenumber depending on surgery date (Categorize Neo and Adjuavnt)
```{r line coding}
therapy_line <- drugs1 %>% 
  # 4. Define Adjuvant, Neoadjuvant, chemo or surgery----
  mutate(chemotherapy_type = case_when(
    # ismaintenancetherapy == "TRUE"    ~ "maintenance",
    episodedate <= surgerydate        ~ "Neoadjuvant", # F63ABD6AEB12C, F4F7B1C5DF24F intraperitoneal Carboplatin
    episodedate > surgerydate         ~ "Adjuvant",
    is.na(surgerydate) &
      !is.na(episodedate)             ~ "Chemotherapy only",
    !is.na(surgerydate) &
      is.na(episodedate)              ~ "Surgery only"
    )) %>% 
  mutate(chemotherapy_type = factor(chemotherapy_type, levels = c("Neoadjuvant", "Adjuvant", "Chemotherapy only", "Surgery only"))) %>%
  group_by(patientid) %>% 
  mutate(had_neo = ifelse(str_detect(chemotherapy_type, "Neo"), "Yes", NA_character_)) %>% 
  fill(had_neo, .direction = "updown") %>% 
  mutate(had_adj = ifelse(str_detect(chemotherapy_type, "Adj"), "Yes", NA_character_)) %>% 
  fill(had_adj, .direction = "updown") %>% 
  mutate(treatment_sequence = case_when(
    had_neo == "Yes" &
      had_adj == "Yes"                           ~ "neo + surg + adj",
    had_neo == "Yes" &
      is.na(had_adj)                             ~ "neo + surg",
    is.na(had_neo) &
      had_adj == "Yes"                           ~ "surg + adj",
    chemotherapy_type == "Chemotherapy only"     ~ "Chemotherapy only",
    chemotherapy_type == "Surgery only"          ~ "Surgery only"
  )) %>% 
  mutate(therapy = case_when(
    chemotherapy_type == "Neoadjuvant"           ~ "Upfront Chemo",
    chemotherapy_type == "Chemotherapy only"     ~ "Chemotherapy only",
    chemotherapy_type == "Surgery only"          ~ "Surgery only",
    is.na(had_neo) &
      had_adj == "Yes"                           ~ "Upfront Surgery"
  )) %>% 
  fill(therapy, .direction = "downup") %>% 
  # mutate(therapy1 = case_when(
  #   chemotherapy_type == "Adjuvant"              ~ "Upfront Surgery",
  # )) %>% 
  # fill(therapy1, .direction = "downup") %>% 
  # mutate(therapy = coalesce(therapy, therapy1)) %>% 
  # select( -therapy1) %>% 
  
  # 5.Redefine line number based on the original linenumber variable and the surgery date----
  mutate(linenumber_new = dense_rank(interaction(linenumber, chemotherapy_type))) %>%  # F0000AD999ABF, F1C68CFAC2AF3, FBCF69031DFF8, F0040EA299CF0, FAACDC7205803,  FA019D2071321 no has big jump F95D860690A93 still weird
  select(patientid, linename, linenumber, linenumber_new, drugname, episodedate, surgerydate, chemotherapy_type, everything()) %>% 
  ungroup() %>% 
  
  # 6.Add a 30 day rule to switch linenumber----
  # group_by(patientid, linenumber_new) %>% 
  # arrange(episodedate) %>% 
  # mutate(episode_interval = episodedate - lag(episodedate), episode_interval = ifelse(is.na(episode_interval), 0, episode_interval)) %>%  # FDB58481AFFBB 48 days
  # mutate(jump_line = ifelse(episode_interval > 31, 1, 0)) %>% # FA019D2071321 >31
  # ungroup() %>% 
  # group_by(patientid) %>% 
  # mutate(jump_line = cumsum(jump_line)) %>% # F002DD2953889 fixed even when increase multiple time 
  # mutate(linenumber_new = linenumber_new + jump_line) %>% 
  #F002DD2953889 need to do 37 and 42 F0040EA299CF0, 35 F005602DA4DF0 => do at least 37
  
  # 7.Calculate cycle for each line----
  mutate(cycle_drugname = str_remove(drugname, " protein-bound")) %>%  # F003F2BEEDB37 need to change drugname pacli = pacli bp
  group_by(patientid, linenumber_new, cycle_drugname) %>% # Wrong line name F001443D8B85C ~~~~~~~~~~~~~~~~~~~~~~~~~~ Fix later QUESTION Dr Chern is ok
  mutate(drugname_count_perline = n()) %>%  # F0000AD999ABF
  ungroup() %>% 
  mutate(across(c("linenumber", "linenumber_new"), as.factor))

# Number of patient with a jump line in the first line # 60 would have
# therapy_line %>% 
#   filter(linenumber == 1 & linenumber_new == 2) %>% 
#   arrange(desc(jump_line)) %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(jump_line) %>% 
#   tbl_summary()
```

### step 6: Remove linename that doesn't include platin or taxels in first line
```{r}
# F0017FB3A8828 starts with gemcitabine then have carbo
therapy_line <- therapy_line %>%
  arrange(patientid, episodedate) %>% 
  mutate(remove_linename_other = case_when(
    linenumber_new == 1 &
      str_detect(linename, "platin|taxel")      ~ "keep",
    linenumber_new == 1 &
      !str_detect(linename, "platin|taxel")     ~ "remove",
  )) %>% 
  group_by(patientid) %>% 
  fill(remove_linename_other, .direction = "down") %>% 
  ungroup() %>% 
  filter(remove_linename_other == "keep") %>% 
  select(-remove_linename_other)

therapy_line %>% 
  filter(linenumber_new == 1) %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  select(linename) %>% 
  tbl_summary(sort = list(everything() ~ "frequency"))

therapy_line %>% distinct(patientid) %>% nrow()
```

We now have `r therapy_line %>% distinct(patientid) %>% nrow()` patients.

#### Number of patient who switch line because of surgery from line 1 to adjuvant line
```{r Number of patient who switch line}
therapy_line %>% 
  mutate(change_line = case_when(
    linenumber == 1 & 
      linenumber_new == 2 &
      chemotherapy_type == "Adjuvant" &
      treatment_sequence == "neo + surg + adj"     ~ 1,
    TRUE                                           ~ 0
  )) %>% 
  arrange(desc(change_line)) %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  select(change_line) %>% 
  tbl_summary()

# Problem F0000AD999ABF but would be good for F003F2BEEDB37
therapy_line %>% 
  filter(str_detect(patientid, "F0000AD999ABF|F003F2BEEDB37")) %>% 
  arrange(patientid, episodedate) %>% 
  select(patientid, linenumber, linenumber_new, episodedate, chemotherapy_type)

therapy_line %>% 
  mutate(change_line = case_when(
    linenumber == 1 & 
      linenumber_new == 2 &
      chemotherapy_type == "Adjuvant" &
      treatment_sequence == "neo + surg + adj"     ~ 1,
    TRUE                                           ~ 0
  )) %>% 
  filter(change_line == 1) %>% 
  group_by(patientid) %>% 
  mutate(firstdate = first(episodedate)) %>% 
  mutate(lastdate = last(episodedate)) %>% 
  ungroup() %>% 
  mutate(time_of_switch_line = interval(start = firstdate, end = lastdate) / duration(n =1, units = "days")) %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x=time_of_switch_line, fill = ..count..))+
  geom_histogram(binwidth = 7)+
  theme_minimal()+
  ggforce::facet_zoom(xlim= c(0,60), zoom.size = 1) + 
  scale_y_continuous(#breaks=c(0, 50, 100, 150),
                     minor_breaks=c(10, 20, 30, 40)#,
                     #labels = c(0, 50, 100, 150)
  )
```

#### How many lines patient got as Neo
```{r}
therapy_line %>% 
  filter(chemotherapy_type == "Neoadjuvant") %>% 
  arrange(desc(linenumber_new)) %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  select(linenumber_new) %>% 
  tbl_summary()

therapy_line %>% 
  filter(chemotherapy_type == "Neoadjuvant" &
           linenumber_new == 2 | linenumber_new == 3 | linenumber_new == 4 | linenumber_new == 5) %>% 
  select(patientid, linename, linenumber, linenumber_new, linestartdate, lineenddate,
         drugname, episodedate, surgerydate, chemotherapy_type) %>%
  arrange(patientid, episodedate)
```

### step 7: Remove patients with more than 1 line as Neo -34
```{r}
remove_morethan1_neo <- therapy_line %>% 
  filter(chemotherapy_type == "Neoadjuvant" &
           linenumber_new != 1)
remove_morethan1_neo <- paste(remove_morethan1_neo$patientid, collapse = "|")

therapy_line <- therapy_line %>% 
  # Remove patients with more than 1 line as Neo
  filter(!str_detect(patientid, remove_morethan1_neo))

therapy_line %>% distinct(patientid) %>% nrow()
```

### step 8: Remove patients who switch cispl vs carbo # 111 patients Car > Cis F1BF7208F0E96, 34 Cis > Car in neo or adj or chemo
```{r}
# But a lot switch cispl vs carbo # 59 patients Car > Cis F1BF7208F0E96, 32 Cis > Car
therapy_line %>% 
  filter(str_detect(linename, "Car") &
           drugname == "cisplatin") %>%
  distinct(patientid) %>% nrow()

therapy_line %>% 
  filter(str_detect(linename, "Cisplatin") &
           drugname == "carboplatin") %>%
  distinct(patientid) %>% nrow()

remove_switch <- therapy_line %>% 
  filter(
    (str_detect(linename, "Carboplatin") & drugname == "cisplatin") |
  (str_detect(linename, "Cisplatin") & drugname == "carboplatin")
  ) %>%
  distinct(patientid)
remove_switch <- paste(remove_switch$patientid, collapse = "|")

therapy_line <- therapy_line %>% 
  # remove these patients who switched C > C 
  filter(!str_detect(patientid, remove_switch))
therapy_line %>% distinct(patientid) %>% nrow()
```

`r emo::ji("question_mark")`  

<span style="color:red">**Should I do the same between paclitaxel and docetaxel?**</span>  

Remember that I coded "paclitaxel" == "paclitaxel protein bound"  

If a patient had carbo, pacli, carbo, pacli, docetaxel in a Carboplatin-Paclitaxel line : It makes the coding for cycle number more difficult  

I think it would be worth it and this operation would remove these patients:

```{r}
# But a lot switch cispl vs carbo # 59 patients Car > Cis F1BF7208F0E96, 32 Cis > Car
therapy_line %>% 
  filter(str_detect(linename, "Pacli") &
           drugname == "docetaxel") %>%
  distinct(patientid) %>% nrow()
therapy_line %>% 
  filter(str_detect(linename, "Doce") &
           drugname == "Paclitaxel") %>%
  distinct(patientid) %>% nrow()
```
<br>

`r emo::ji("question_mark")`  
<span style="color:red">**Random question : within 1 cycle we can have taxel multiple times, is it possible for carboplatin or cisplatin?**</span>  

<br>

### step 9: Code cycle
```{r cycle coding}
# Code cycle number
therapy_cycle <- therapy_line %>% 

  arrange(patientid, episodedate) %>% 
  group_by(patientid, linenumber_new) %>%
  # Need the number of time of the "major" drug is seen in the line
  mutate(cycle_count_perline = min(drugname_count_perline)) %>%
  mutate(cycle_drugname = case_when(
    cycle_count_perline == drugname_count_perline          ~ drugname,
    TRUE                                                   ~ NA_character_
  )) %>% 
  # select(-drugname_count_perline) %>% 
  group_by(patientid, linenumber_new, cycle_drugname) %>%
  mutate(cycle_inc = row_number(cycle_drugname)) %>% # Look at F002DD2953889 had a long time without one drug------------------
  

  # + What to do when it is a cycle change F003F2BEEDB37 , 
  
  
  # group_by(patientid, linenumber_new, cycle_inc) %>%
  # mutate(cycle_count_1 = row_number(cycle_inc)) %>% 
  # mutate(cycle_c = ifelse(cycle_count_1 == 1, cycle_inc, NA_real_)) %>% 
  arrange(patientid, episodedate, cycle_inc) %>% 
  group_by(patientid, linenumber_new) %>%
  mutate(cycle_increment = cycle_inc) %>% 
  fill(cycle_increment, .direction = "downup") %>%  # make sure I can do up for have one new drug compare to the linename FBB5186A15CD9, FE593EDF5586A
  # cycle date
  group_by(patientid, linenumber_new, cycle_increment) %>% 
  mutate(cycle_start_date = min(episodedate)) %>% 
  # select(patientid, linename, linenumber_new, drugname, episodedate,
  #        cycle_count_perline, cycle_drugname, drugname_count_perline, cycle_increment, cycle_start_date) %>% 
  
  group_by(patientid, linenumber_new) %>% 
  mutate(cycle_interval = cycle_start_date - lag(cycle_start_date), 
         cycle_interval = ifelse(cycle_interval == 0, NA_real_, cycle_interval)) %>%  # FDB58481AFFBB 48 days
  
  # take for granted that the cycle interval days are the routine cycle for the rest of the line FAACDC7205803
  mutate(n = row_number(drugname)) %>%

  mutate(base_days_between_cycle = ifelse(n==2 , cycle_interval, NA_real_)) %>%
  fill(base_days_between_cycle, .direction = "downup") %>% 
  mutate(skipped_cycle_indays = ifelse(((cycle_interval - base_days_between_cycle) != 0) ,
                                       (cycle_interval - base_days_between_cycle), NA_real_)) %>% # weird FDB58481AFFBB
  # Fix skipped_cycle_indays when only 1 drug FDB58481AFFBB skipped_cycle_indays = NA, no other choice...
  group_by(patientid, linenumber_new) %>%
  mutate(drug_count_perline = n()) %>%
  mutate(skipped_cycle_indays1 = ifelse(
    (cycle_count_perline == drug_count_perline), NA_real_, skipped_cycle_indays 
  )) %>% # F001443D8B85C Pb with when different pattern by cycle => May not be able to have the skipped cycle
  # or need to compare with dose like if 100 should be 7 days and if 200 should be 14 days....
  group_by(patientid) %>% 
  mutate(mean_skipped_cycle_indays = mean(skipped_cycle_indays, na.rm = TRUE)) %>% 
  ungroup()
```


### step 10: Bind everything together and calculating target_auc and expected dose

When I bind things together I take the closest date of creatinine, height, weight, BSA, AUC, from the cycle date to calculate `target_auc` and `expected_dose`. it can be days in between or more. 
`r emo::ji("question_mark")`  
<span style="color:red">**Do we need a maximun?**</span>  

As you can see on the plots, the gap can be pretty big so :  
<span style="color:red">**Can we take a creatinine value to bind it to a drug when a year long as past between each other?**</span>  
<span style="color:red">**Same question for height, weight, bsa and corresponding AUC**</span>  

Precision when binding for AUC I bind the closest with corresponding drugname (Pacli AUC is not bind with Carbo drug)
```{r target_auc and expected dose}
Treatment <- 
  # Merge with creatinine
  left_join(therapy_cycle, creatinine, by = "patientid") %>%
  mutate(interval_creat = abs(interval(start= creat_date, end= cycle_start_date)/                      
                          duration(n=1, unit="days"))) %>% 
  arrange(interval_creat) %>% 
  distinct(patientid, episodedate, drugname, amount, linenumber_new, cycle_count_perline, cycle_increment, 
           cycle_start_date, .keep_all = TRUE) %>% 
  
  # Merge with height
  left_join(. , height,  by = "patientid") %>%
  mutate(interval_height = abs(interval(start= height_date, end= cycle_start_date)/
           duration(n=1, unit="days"))) %>%
  arrange(interval_height) %>%
  distinct(patientid, episodedate, drugname, amount, linenumber_new, cycle_count_perline, cycle_increment,
           cycle_start_date, .keep_all = TRUE) %>%
  
  # Merge with weight
  left_join(. , weight, by = "patientid") %>%
  mutate(interval_weight = abs(interval(start= weight_date, end= cycle_start_date)/
                        duration(n=1, unit="days"))) %>%
  arrange(interval_weight) %>%
  distinct(patientid, episodedate, drugname, amount, linenumber_new, cycle_count_perline, cycle_increment,
         cycle_start_date, .keep_all = TRUE) %>%

  # Calculate bmi
  mutate(bmi_at_dx = weight_at_dx / (height_at_dx * height_at_dx)) %>%
  mutate(bmi_cat = case_when(
    bmi_at_dx < 25                    ~ "Underweight and normal weight",
    bmi_at_dx >= 25 &
      bmi_at_dx < 30                  ~ "Overweight",
    bmi_at_dx >= 30                   ~ "Obese"
  )) %>%
  mutate(bmi_cat = factor(bmi_cat, levels = c("Underweight and normal weight", "Overweight", "Obese"))) %>%
  # Calculate CrCl
  inner_join(., clinical_data %>% select(-surgerydate),
             by = "patientid") %>% 
  mutate(CrCl = ((140 - ageatdx) * weight)/((72 * creatinine) * 0.85)) %>%
  mutate(CrCl = case_when(
    CrCl > 125                        ~ 125,
    TRUE                              ~ CrCl
  )) %>% 

  # Merge with body_surface_area
  left_join(., body_surface_area, by = "patientid") %>%
  mutate(interval_bsa = abs(interval(start= bsa_date, end= cycle_start_date)/
                          duration(n=1, unit="days"))) %>%
  arrange(interval_bsa) %>%
  distinct(patientid, episodedate, drugname, amount, linenumber_new, cycle_count_perline, cycle_increment,
           cycle_start_date, .keep_all = TRUE) %>%
  # Calculate more bsa value with height and weight using Du Bois formula
  mutate(bsa_du_bois = 0.007184 * ((height*100)^0.725) * (weight^0.425)) %>% # get pretty close results 4269 patients result
  mutate(BSA = coalesce(BSA, bsa_du_bois)) %>%
  mutate(bsa_du_bois = 0.007184 * ((height_at_dx*100)^0.725) * (weight_at_dx^0.425)) %>% # get pretty close results 4269 patients result
  mutate(bsa_at_dx = coalesce(bsa_at_dx, bsa_du_bois)) %>%
  select(-bsa_du_bois) %>%

  # Merge with auc
  left_join(., areaUC, by = c("patientid", "drugname")) %>%
  mutate(interval_auc = abs(interval(start= auc_date, end= cycle_start_date)/ # use episode date to be more precise? No it's not better
                          duration(n=1, unit="days"))) %>% 
  arrange(interval_auc) %>% 
  distinct(patientid, episodedate, drugname, amount, linenumber_new, cycle_count_perline, cycle_increment, 
           cycle_start_date, .keep_all = TRUE) %>% 

  # Calculate expected dose
  mutate(expected_dose = case_when(
    drugname == "carboplatin"                 ~ target_auc * (CrCl + 25),
    str_detect(drugname, "taxel|platin")      ~ BSA * target_auc 
    # F19EBBFC60652 Can we fill target_auc? No depends of the type of cycle, or maybe by grouping by cycle type and drug
  )) %>% 
  mutate(expected_dose = case_when(
    expected_dose > 900 &
      target_auc == 6              ~ 900,
    expected_dose > 750 &
      target_auc == 5              ~ 750,
    TRUE                           ~ expected_dose
  )) %>% 
  mutate(first_treatment_date = case_when(
    str_detect(therapy, "Chemo")                      ~ min(episodedate),
    str_detect(therapy, "Surgery")                    ~ surgerydate,
  )) %>% 
  mutate(month_at_os_from_treatment = interval(start = first_treatment_date, end = followupdate)/
                   duration(n=1, units = "months")) %>% 
  arrange(patientid, episodedate)
```

```{r plot interval}
Treatment %>% 
  ggplot(aes(x= interval_creat)) +
  geom_bar() +
  coord_cartesian(ylim=c(0,50))
Treatment %>% 
  ggplot(aes(x= interval_height)) +
  geom_bar() +
  coord_cartesian(ylim=c(0,50))
Treatment %>% 
  ggplot(aes(x= interval_weight)) +
  geom_bar() +
  coord_cartesian(ylim=c(0,50))
Treatment %>% 
  ggplot(aes(x= interval_bsa)) +
  geom_bar() +
  coord_cartesian(ylim=c(0,50))
Treatment %>% 
  ggplot(aes(x= interval_auc)) +
  geom_bar() +
  coord_cartesian(ylim=c(0,50))
```

## We have `r Treatment %>% distinct(patientid) %>% nrow()` patients with drug and clinical info but

### step 11: Exclude exclude == "1" coded by Lauren due to Flatiron rule

```{r analysis_data}
analysis_data <- Treatment %>% 
  filter(exclude != "1")
```


# **Number of patients in almost final dataset is `r analysis_data %>% distinct(patientid) %>% nrow()`**

## Explore the dataset
Number of line in neo
```{r}
analysis_data %>% 
  filter(chemotherapy_type == "Neoadjuvant") %>% 
  arrange(desc(linenumber_new)) %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  select(linenumber_new) %>% 
  tbl_summary()
```
Number of line in Adj neo + surg + adj
```{r}
analysis_data %>% 
  filter(chemotherapy_type == "Adjuvant" & treatment_sequence == "neo + surg + adj") %>% 
  mutate(n = dense_rank(linenumber_new)) %>% 
  arrange(desc(n)) %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(n) %>% 
  tbl_summary()
```
Number of line in Adj surg + adj
```{r}
analysis_data %>% 
  filter(chemotherapy_type == "Adjuvant" & treatment_sequence == "surg + adj") %>% 
  mutate(n = dense_rank(linenumber_new)) %>% 
  arrange(desc(n)) %>%
  distinct(patientid, .keep_all = TRUE) %>%
  select(n) %>% 
  tbl_summary()
```
Number of line in Chemotherapy only
```{r}
analysis_data %>% 
  filter(chemotherapy_type == "Chemotherapy only") %>% 
  arrange(desc(linenumber_new)) %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  select(linenumber_new) %>% 
  tbl_summary()
```

# 

```{r}
library(naniar)
analysis_data %>%
  distinct(patientid, .keep_all = TRUE) %>% 
  select(bmi_at_dx, weight_at_dx, height_at_dx, bsa_at_dx) %>% 
  gg_miss_upset()

analysis_data %>% select(creatinine, CrCl, target_auc, expected_dose) %>% 
  gg_miss_upset()

is.na(analysis_data$CrCl) %>% sum()
is.na(analysis_data$amount) %>% sum()
is.na(analysis_data$target_auc) %>% sum()

# analysis_data %>% filter(is.na(amount)) %>%
#     distinct(patientid, .keep_all = TRUE) %>% nrow()
# 
# analysis_data %>% filter(is.na(target_auc) | is.na(expected_dose)) %>%
#     distinct(patientid, .keep_all = TRUE) %>% nrow()
```
If we remove patients who have at least 1 missing amount administrered, we lose `r analysis_data %>% filter(is.na(amount)) %>% distinct(patientid, .keep_all = TRUE) %>% nrow()` patients.  

If we remove patients who are missing at least 1 target_auc or 1 expected dose we lose `r analysis_data %>% filter(is.na(target_auc) | is.na(expected_dose)) %>% distinct(patientid, .keep_all = TRUE) %>% nrow()` patients.  

# CALCULATE RDI

`r emo::ji("question_mark")`  
<span style="color:red">**I need confirmation : we calculate 1 RDI per drug per patient for the first (unique) line of neoadjuvant and 1 RDI per drug per patient for the ALL the lines of adjuvant which are not maintenance. Is that correct**</span>  

## Calculate RDI by drug by cycle by patient
Here few examples
```{r, rows.print=15, max.print=30}
Frontline <- Treatment %>% 
  # Calculate RDI for each drug per cycle per patients
  mutate(relative_dose_intensity = amount/expected_dose) %>% 
  group_by(patientid, linenumber_new, cycle_drugname,  chemotherapy_type, linestartdate, lineenddate, cycle_increment) %>% 
  summarise(across(relative_dose_intensity, mean, na.rm = TRUE))

Frontline
```

## Calculate RDI by drug by line by patient
Here few examples
```{r, rows.print=15, max.print=30}
Frontline <- Frontline %>% 
  # Calculate RDI for each drug per line per patients
  group_by(patientid, linenumber_new, cycle_drugname,  chemotherapy_type, linestartdate, lineenddate) %>% 
  summarise(across(relative_dose_intensity, mean, na.rm = TRUE))

Frontline
```

## Calculate RDI by drug by patient
Here few examples
```{r, rows.print=15, max.print=30}
Frontline <- Frontline %>% 
  # Calculate RDI for each drug per patients
  group_by(patientid, cycle_drugname, chemotherapy_type) %>% 
  summarise(across(relative_dose_intensity, mean, na.rm = TRUE)) %>% 
  ungroup()

Frontline


Frontline %>% 
  ggplot(aes(x = relative_dose_intensity, fill = cycle_drugname))+
  geom_histogram(alpha = 0.5)+
  theme_minimal()+
  facet_wrap(.~ chemotherapy_type, scales = "free")

Frontline %>% 
  ggplot(aes(x = relative_dose_intensity, y = chemotherapy_type, fill = cycle_drugname))+
  geom_boxplot()+
  geom_vline(xintercept = 1, color = "red")+
  theme_minimal()
```


```{r}
Frontline <- Frontline %>% 

  mutate(RDI_grp = case_when(
    relative_dose_intensity < 0.85          ~ "RDI < 0.85",
    relative_dose_intensity >= 0.85         ~ "RDI >= 0.85"
  )) %>% 
  mutate(RDI_grp = factor(RDI_grp, 
                           labels = c("RDI >= 0.85", "RDI < 0.85"))) %>% 
  mutate(RDI_grp1 = case_when(
    relative_dose_intensity < 0.85          ~ "RDI < 0.85",
    # relative_dose_intensity >= 0.85         ~ "RDI >= 0.85",
    relative_dose_intensity >= 0.85 &
      relative_dose_intensity <= 1          ~ "0.85 <= RDI <= 1",
    relative_dose_intensity > 1 &
      relative_dose_intensity <= 1.5        ~ "1 < RDI <= 1.5",
    relative_dose_intensity > 1.5 &
      relative_dose_intensity <= 2          ~ "1.5 < RDI <= 2",
    relative_dose_intensity > 2             ~ "RDI > 2",
  )) %>% 
  mutate(RDI_grp1 = factor(RDI_grp1, 
                          labels = c("RDI < 0.85", 
                                     "0.85 >= RDI <= 1", 
                                     "1 < RDI <= 1.5", 
                                     "1.5 < RDI <= 2", 
                                     "RDI > 2"))) %>% 
  # mutate(delay_incare_dx_to_treat = case_when(
  #   str_detect(therapy, "Chemo")     ~ (interval(start = diagnosisdate, end = episodedate)/
  #     duration(n=1, units = "days")),
  #   str_detect(therapy, "Surgery")   ~ (interval(start = diagnosisdate, end = surgerydate)/
  #     duration(n=1, units = "days"))
  # )) %>% 
  left_join(., Treatment) %>% 
  group_by(patientid) %>%
  mutate(first_treatment_date = case_when(
    treatment_sequence == "Chemotherapy only"             ~ min(episodedate),
    str_detect(treatment_sequence, "neo")                 ~ min(episodedate),
    treatment_sequence == "surg + adj"                    ~ surgerydate,
    treatment_sequence == "Surgery only"                  ~ surgerydate
  )) %>%
  # group_by(patientid) %>% 
  # mutate(first_treatment_date = case_when(
  #   str_detect(therapy, "Chemo")                      ~ min(episodedate),
  #   str_detect(therapy, "Surgery")                    ~ surgerydate,
  # )) %>% 
  # mutate(delay_incare_dx_to_treat = interval(start = diagnosisdate, end = first_treatment_date)/
  #                                         duration(n=1, units = "days")) %>% 
  mutate(month_at_os_from_treatment = interval(start = first_treatment_date, end = followupdate)/
                   duration(n=1, units = "months")) %>% 
  ungroup()


```


# STOP HERE








# Analysis

## 1.Clinical summary table


<span style="color:green">**Table 1 Overall summary demographic/clinical data**</span>
```{r Table 1}



# How should I filter??????????????????///
analysis_data %>% distinct(patientid, .keep_all = TRUE) %>% 
  select(c(raceeth, 
           agecat, "ageatdx",
            
           bmi_at_dx, bmi_cat, 
           weight_at_dx, height_at_dx, bsa_at_dx,
           
           "histology", "stagecat",
           
           "brca1_germline", "brca2_germline", "brca_germline", "brca1_tumor",
           "brca2_tumor", "brca_tumor", "brca1_unknown", "brca2_unknown", "brca_unknown")) %>% 
  tbl_summary() %>% bold_labels()
```

<span style="color:green">**Table 2 Summary demographic/clinical data by race**</span>
```{r Table 2}
analysis_data %>% 
  select(c(raceeth, "vital",
           agecat, "ageatdx",
            
           "bmi_at_dx", bmi_cat, "BSA",
           
           "histology", "groupstage", "tstage", "stagecat",
           
           "brca1_germline", "brca2_germline", "brca_germline", "brca1_tumor",
           "brca2_tumor", "brca_tumor", "brca1_unknown", "brca2_unknown", "brca_unknown", 
           
           "hrd_tissue", "gis_tissue")) %>% 
  tbl_summary(by = raceeth) %>% bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
```
<br>

## 2.Plots Clinical
<div class = "row">
<div class = "col-md-6">
```{r}
analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= bmi_cat))+
  geom_bar()+
  theme_minimal()+
  labs(title = "BMI category")+
  coord_flip()

analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= histology))+
  geom_bar()+
  theme_minimal()+
  labs(title = "Histology")+
  coord_flip()

analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= stagecat))+
  geom_bar()+
  theme_minimal()+
  labs(title = "Stage")+
  coord_flip()

analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= agecat))+
  geom_bar()+
  theme_minimal()+
  labs(title = "Age cat")+
  coord_flip()

analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= brca_germline))+
  geom_bar()+
  theme_minimal()+
  labs(title = "BRCA gernline")+
  coord_flip()

analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= brca_tumor))+
  geom_bar()+
  theme_minimal()+
  labs(title = "BRCA tumor")+
  coord_flip()
```
</div>

<div class = "col-md-6">
```{r}
analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= raceeth, fill = bmi_cat))+
  geom_bar(position = "fill")+
  theme_minimal()+
  labs(title = "BMI category")+
  coord_flip()

analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= histology, fill = raceeth))+
  geom_bar(position = "fill")+
  theme_minimal()+
  labs(title = "Histology")+
  coord_flip()

analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= stagecat, fill = raceeth))+
  geom_bar(position = "fill")+
  theme_minimal()+
  labs(title = "Stage")+
  coord_flip()

analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= agecat, fill = raceeth))+
  geom_bar(position = "fill")+
  theme_minimal()+
  labs(title = "Age cat")+
  coord_flip()

analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= brca_germline, fill = raceeth))+
  geom_bar(position = "fill")+
  theme_minimal()+
  labs(title = "BRCA germline")+
  coord_flip()

analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= brca_tumor, fill = raceeth))+
  geom_bar(position = "fill")+
  theme_minimal()+
  labs(title = "BRCA tumor")+
  coord_flip()
```
</div>
</div>

<br>

## 3.Survivals by clinical

<span style="color:green">**Survival plots from date of diagnosis on the left and from date of treatment on the right**</span>  

<div class = "row">
<div class = "col-md-6">
```{r clinical from dx, fig.height = 7}
# OS by race
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ race, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by raceeth
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ raceeth, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by histology
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ histology, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by tstage
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ stagecat, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by bmi_cat
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ bmi_cat, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by brca1_tumor
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ brca1_tumor, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by brca2_tumor
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ brca2_tumor, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by brca_tumor
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ brca_tumor, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by brca1_g
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ brca1_germline, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by brca2_g
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ brca2_germline, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by brca_g
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ brca_germline, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))
```
</div>

<div class = "col-md-6">
```{r clinical from first treatment, fig.height = 7}
# OS by race
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ race, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by raceeth
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ raceeth, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by histology
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ histology, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by tstage
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ stagecat, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by bmi_cat
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ bmi_cat, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by brca1_tumor
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ brca1_tumor, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by brca2_tumor
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ brca2_tumor, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by brca_tumor
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ brca_tumor, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))
# OS by brca1_g
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ brca1_germline, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by brca2_g
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ brca2_germline, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by brca_g
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ brca_germline, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))
```
</div>
</div>

<br>
<br>

***
# II.Analysis Treatment

## 1.Treatment summary table

<span style="color:green">**Table 3 Summary treatment data by race**</span>

```{r Table 3}
# tbl1 <- 
  analysis_data %>% distinct(patientid, .keep_all = TRUE) %>% 
  select(c(raceeth, #delay_incare_dx_to_treat, #mean_skipped_cycle_indays,
           "issurgery", "extentofdebulking", "resdz", "debulking", "diff_surg_dx",
           had_neo, had_adj,
           "chemotherapy_type", "therapy", "treatment_sequence"#, "mean_RDI_per_drug_chemotype", "RDI_grp"
           )) %>% 
  tbl_summary(by = raceeth) %>% bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl2 <- analysis_data %>% distinct(patientid, .keep_all = TRUE) %>% 
#   filter(exclude != "1") %>% 
#   select(c(raceeth, delay_incare_dx_to_treat, #mean_skipped_cycle_indays,
#            "issurgery", "extentofdebulking", "resdz", "debulking", "diff_surg_dx",
#            "chemotherapy_type", "therapy", "treatment_sequence"#, "mean_RDI_per_drug_chemotype", "RDI_grp"
#            )) %>% 
#   tbl_summary(by = raceeth, missing = "no") %>% bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl_merge(list(tbl1, tbl2), tab_spanner = c("with unknown", "without unknown"))
```
<br>

## 2.Plots Treatment
<div class = "row">
<div class = "col-md-6">
```{r}
analysis_data %>%
  distinct(patientid, .keep_all = TRUE) %>% 
  ggplot(aes(x= therapy))+
  geom_bar()+
  theme_minimal()+
  labs(title = "Frontline treatment")+
  coord_flip()

# analysis_data %>% 
#   arrange(episodedate) %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   group_by(chemotherapy_type) %>% 
#   summarize(count = n()) %>% mutate(percent=(count/sum(count)*100)) %>%
#   ggplot(aes(x= chemotherapy_type, y= percent, fill = chemotherapy_type))+
#   geom_bar(stat="identity")+
#   labs(x = "", title = "The first chemotherapy received by a patient Adjuvant for ~70% of the time") +
#   theme_minimal()+
#   guides(fill = FALSE) +
#   coord_flip()
```
</div>

<div class = "col-md-6">
```{r}
analysis_data %>% 
  distinct(patientid, .keep_all = TRUE) %>% 
  # group_by(treatment_sequence) %>% 
  # summarize(count = n()) %>% mutate(percent=(count/sum(count)*100)) %>%
  ggplot(aes(x= treatment_sequence,
             # y= percent, 
             fill = treatment_sequence))+
  geom_bar(
    # stat="identity"
    )+
  labs(x = "", title = "The treatment_sequence") +
  theme_minimal()+
  guides(fill = FALSE) +
  coord_flip()

# analysis_data %>% distinct(patientid, .keep_all = TRUE) %>% 
#   ggplot(aes(x= chemo))+
#   geom_bar()+
#   theme_minimal()+
#   coord_flip()
```
</div>
</div>

<br>

## 3.Survivals by treatment

<div class = "row">
<div class = "col-md-6">
```{r, fig.height = 7}
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ issurgery, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by extentofdebulking
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ extentofdebulking, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by residualdiseasestatus
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ residualdiseasestatus, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))



# OS by chemotherapy_type
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ chemotherapy_type, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by treatment_sequence
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ treatment_sequence, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by therapy
ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ therapy, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of diagnosis", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))
```
</div>

<div class = "col-md-6">
```{r, fig.height = 7}
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ issurgery, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of from first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by extentofdebulking
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ extentofdebulking, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of from first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by residualdiseasestatus
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ residualdiseasestatus, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of from first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))



# OS by chemotherapy_type
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ chemotherapy_type, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of from first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))

# OS by treatment_sequence
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ treatment_sequence, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of from first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(nrow = 3))

# OS by therapy
ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ therapy, data=analysis_data %>% 
                     distinct(patientid, .keep_all = TRUE) %>% 
                     filter(exclude != "1")),
           title = "OS from date of from first treatment", 
           font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           # Add risk table
           risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
           risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(16, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(19, "bold", "black")
           ),
           
           legend.title = "", xlab = "Time (in months)" 
) + guides(colour = guide_legend(ncol = 2))
```
</div>
</div>

<br>
<br>

***
# III.RDI

## 1.RDI summary table

<span style="color:green">**Table 4 Summary RDI data by race and bmi**</span>

```{r Table 4}

# Frontline %>% group_by(chemotherapy_type, drugname) %>% summarize(average_RDI =mean(mean_RDI_per_drug_chemotype, na.rm = TRUE)) 
# 
# # Treatment & demo
# tbl1 <- analysis_data %>% filter(drugname == "carboplatin" & chemotherapy_type == "Adjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(raceeth,  "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = raceeth,
#               label = list(mean_RDI_per_drug_chemotype ~ "carb/adjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl2 <- analysis_data %>% filter(drugname == "carboplatin" & chemotherapy_type == "Adjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(bmi_cat,  "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = bmi_cat,
#               label = list(mean_RDI_per_drug_chemotype ~ "carb/adjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl3 <- 
#   tbl_merge(list(tbl1, tbl2), tab_spanner = c("Race/Ethnicity", "BMI"))
# 
# tbl1 <- analysis_data %>% filter(drugname == "carboplatin" & chemotherapy_type == "Neoadjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(raceeth, "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = raceeth,
#               label = list(mean_RDI_per_drug_chemotype ~ "carb/neoadjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl2 <- analysis_data %>% filter(drugname == "carboplatin" & chemotherapy_type == "Neoadjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(bmi_cat, "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = bmi_cat,
#               label = list(mean_RDI_per_drug_chemotype ~ "carb/neoadjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl4 <- 
#   tbl_merge(list(tbl1, tbl2), tab_spanner = c("Race/Ethnicity", "BMI"))
# 
# tbl1 <- analysis_data %>% filter(str_detect(drugname, "cisplatin") & chemotherapy_type == "Adjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(raceeth, "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = raceeth,
#               label = list(mean_RDI_per_drug_chemotype ~ "cisplatin/adjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl2 <- analysis_data %>% filter(str_detect(drugname, "cisplatin") & chemotherapy_type == "Adjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(bmi_cat, "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = bmi_cat,
#               label = list(mean_RDI_per_drug_chemotype ~ "cisplatin/adjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl5 <- 
#   tbl_merge(list(tbl1, tbl2), tab_spanner = c("Race/Ethnicity", "BMI"))
# 
# tbl1 <- analysis_data %>% filter(str_detect(drugname, "cisplatin") & chemotherapy_type == "Neoadjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(raceeth, "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = raceeth,
#               type = list(mean_RDI_per_drug_chemotype ~ 'continuous'),
#               label = list(mean_RDI_per_drug_chemotype ~ "cisplatin/neoadjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl2 <- analysis_data %>% filter(str_detect(drugname, "cisplatin") & chemotherapy_type == "Neoadjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(bmi_cat, "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = bmi_cat,
#               type = list(mean_RDI_per_drug_chemotype ~ 'continuous'),
#               label = list(mean_RDI_per_drug_chemotype ~ "cisplatin/neoadjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl6 <- 
#   tbl_merge(list(tbl1, tbl2), tab_spanner = c("Race/Ethnicity", "BMI"))
# 
# tbl_stack(list(tbl4, tbl3, tbl5, tbl6), quiet = TRUE)
# 
# 
# 
# tbl1 <- analysis_data %>% filter(str_detect(drugname, "taxel") & chemotherapy_type == "Adjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(raceeth, "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = raceeth,
#               label = list(mean_RDI_per_drug_chemotype ~ "taxel/adjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl2 <- analysis_data %>% filter(str_detect(drugname, "taxel") & chemotherapy_type == "Adjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(bmi_cat, "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = bmi_cat,
#               label = list(mean_RDI_per_drug_chemotype ~ "taxel/adjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl5 <- 
#   tbl_merge(list(tbl1, tbl2), tab_spanner = c("Race/Ethnicity", "BMI"))
# 
# tbl1 <- analysis_data %>% filter(str_detect(drugname, "taxel") & chemotherapy_type == "Neoadjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(raceeth, "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = raceeth,
#               label = list(mean_RDI_per_drug_chemotype ~ "taxel/neoadjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl2 <- analysis_data %>% filter(str_detect(drugname, "taxel") & chemotherapy_type == "Neoadjuvant") %>% 
#   filter(exclude != "1") %>% 
#   distinct(patientid, .keep_all = TRUE) %>% 
#   select(c(bmi_cat, "mean_RDI_per_drug_chemotype", RDI_grp)) %>% 
#   tbl_summary(by = bmi_cat,
#               label = list(mean_RDI_per_drug_chemotype ~ "taxel/neoadjuvant \nRDI")) %>%
#   bold_labels() %>% add_overall() %>% add_p() %>% bold_p(t = .05)
# tbl6 <- 
#   tbl_merge(list(tbl1, tbl2), tab_spanner = c("Race/Ethnicity", "BMI"))
# 
# tbl_stack(list(tbl5, tbl6), quiet = TRUE)
```
<br>

## 2.Plots RDI
For RDI boxplot and violin, it is calculated for neoadjuvant and adjuvant when a patient got both (need to find another way of plotting to do by drug - maybe a wrap).

<div class = "row">
<div class = "col-md-6">
```{r}
# analysis_data %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>%
#   ggplot(aes(x= chemotherapy_type, y= mean_RDI_per_drug_chemotype))+
#   geom_boxplot()+
#   ylim(c(-.25, 3.5))+
#   geom_jitter(shape=16)+
#   labs(x = "", title = "Warning 1 dot = RDI for 1 drugname per patient") +
#   theme_minimal()
# 
# analysis_data %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>%
#   # filter(linenumber_new == "1") %>% 
#   ggplot(aes(x= chemotherapy_type, y= mean_RDI_per_drug_chemotype))+
#   geom_violin()+
#   ylim(c(-.25, 3.5))+
#   # geom_jitter(shape=16, aes(color=mean_RDI_per_drug_chemotype<0.85))+
#   theme_minimal()
# 
# analysis_data %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>%
#   # filter(linenumber_new == "1") %>% 
#   ggplot(aes(x= drugname, y= mean_RDI_per_drug_chemotype))+
#   geom_violin()+
#   ylim(c(-.25, 3.5))+
#   # geom_jitter(shape=16, aes(color=mean_RDI_per_drug_chemotype<0.85))+
#   theme_minimal()+
#   coord_flip()
# 
# analysis_data %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>%
#   # filter(linenumber_new == "1") %>% 
#   ggplot(aes(x= RDI_grp, fill = drugname))+
#   geom_bar()+
#   theme_minimal()+
#   coord_flip()


```
</div>

<div class = "col-md-6">
```{r}
# analysis_data %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>%
#   # filter(linenumber_new == "1") %>% 
#   ggplot(aes(x= chemotherapy_type, y= mean_RDI_per_drug_chemotype))+
#   # geom_boxplot()+
#   ylim(c(-.25, 3.5))+
#   geom_jitter(shape=16, aes(color=mean_RDI_per_drug_chemotype<0.85))+
#   labs(x = "", title = "Warning 1 dot = RDI for 1 drugname per patient") +
#   theme_minimal() +
#   guides(color=FALSE)
# 
# analysis_data %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>%
#   # filter(linenumber_new == "1") %>% 
#   ggplot(aes(x= chemotherapy_type, y= mean_RDI_per_drug_chemotype, color = mean_RDI_per_drug_chemotype<0.85))+
#   geom_violin()+
#   ylim(c(-.25, 2.5))+
#   scale_colour_discrete(name=NULL, labels=c(">=0.85", "<0.85"))+
#   # geom_jitter(shape=16, aes(color=mean_RDI_per_drug_chemotype<0.85))+
#   theme_minimal()
# 
# analysis_data %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>%
#   # filter(linenumber_new == "1") %>% 
#   ggplot(aes(x= drugname, y= mean_RDI_per_drug_chemotype))+
#   geom_violin(aes(color=mean_RDI_per_drug_chemotype<0.85))+
#   ylim(c(-.25, 2.5))+
#   scale_colour_discrete(name=NULL, labels=c(">=0.85", "<0.85"))+
#   # geom_jitter(shape=16, aes(color=mean_RDI_per_drug_chemotype<0.85))+
#   theme_minimal()+
#   coord_flip()
# 
# analysis_data %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>%
#   # filter(linenumber_new == "1") %>% 
#   ggplot(aes(x= RDI_grp, fill = drugname))+
#   geom_bar(position = "fill")+
#   theme_minimal()+
#   coord_flip()
# 

```
</div>
</div>

```{r}
# analysis_data %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>%
#   # filter(linenumber_new == "1") %>% 
#   ggplot(aes(x= chemotherapy_type, y= mean_RDI_per_drug_chemotype, alpha = mean_RDI_per_drug_chemotype<0.85))+
#   geom_violin(aes(fill = drugname))+
#   ylim(c(-.25, 2.5))+
#   scale_colour_discrete(name=NULL, labels=c(">=0.85", "<0.85"))+
#   # geom_jitter(shape=16, aes(color=mean_RDI_per_drug_chemotype<0.85))+
#   theme_minimal()
```

A quick summary for the RDI repartition
```{r}
# analysis_data2 <- analysis_data# %>% filter(linenumber_new == "1")
# summary(analysis_data2$mean_RDI_per_drug_chemotype)
```

<div class = "row">
<div class = "col-md-6">
```{r}
# analysis_data %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>%
#   # filter(linenumber_new == "1") %>% 
#   ggplot(aes(x= RDI_grp1, fill = drugname))+
#   geom_bar()+
#   theme_minimal()+
#   coord_flip()
```
</div>

<div class = "col-md-6">
```{r}
# analysis_data %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>%
#   # filter(linenumber_new == "1") %>% 
#   ggplot(aes(x= RDI_grp1, fill = drugname))+
#   geom_bar(position = "fill")+
#   theme_minimal()+
#   coord_flip()
```
</div>
</div>

<br>

## 3.Survivals by RDI

<div class = "row">
<div class = "col-md-6">
```{r, fig.height = 7}
# OS by RDI_grp
# ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      distinct(patientid, .keep_all = TRUE) %>% 
#                      filter(exclude != "1")),
#            title = "OS from diagnosis Overall RDI", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
# 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
# 
# # OS by RDI_grp for platin
# ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "carboplatin")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from diagnosis carboplatin", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
# 
# ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "cisplatin")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from diagnosis cisplatin", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
# 
# # OS by RDI_grp for taxel
# ggsurvplot(survfit(Surv(month_at_os, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "taxel")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from diagnosis all taxel", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
```
</div>

<div class = "col-md-6">
```{r, fig.height = 7}
# # OS by RDI_grp
# ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      distinct(patientid, .keep_all = TRUE) %>% 
#                      filter(exclude != "1")),
#            title = "OS from first treatment overall RDI", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
# 
# # OS by RDI_grp for platin
# ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "carboplatin")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from first treatment carboplatin", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
# 
# ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "cisplatin")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from first treatment cisplatin", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
# 
# # OS by RDI_grp for taxel
# ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "taxel")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from from first treatment all taxel", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
```
</div>
</div>

<br>

## Survivals RDI by chemotherapy type
**On the left are Neoadjuvant, on the right are Adjuvant**

<div class = "row">
<div class = "col-md-6">
```{r, fig.height = 7}
# # OS by RDI_grp for platin
# ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "carboplatin"),
#                             str_detect(chemotherapy_type, "Neoadjuvant")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from first treatment carboplatin", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
# 
# ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "cisplatin"),
#                             str_detect(chemotherapy_type, "Neoadjuvant")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from first treatment cisplatin", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
# 
# # OS by RDI_grp for taxel
# ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "taxel"),
#                             str_detect(chemotherapy_type, "Neoadjuvant")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from from first treatment all taxel", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
```
</div>

<div class = "col-md-6">
```{r, fig.height = 7}
# # OS by RDI_grp for platin
# ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "carboplatin"),
#                             str_detect(chemotherapy_type, "Adjuvant")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from first treatment carboplatin", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
# 
# ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "cisplatin"),
#                             str_detect(chemotherapy_type, "Adjuvant")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from first treatment cisplatin", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
# 
# # OS by RDI_grp for taxel
# ggsurvplot(survfit(Surv(month_at_os_from_treatment, vitalstatus) ~ RDI_grp, data=Frontline %>% 
#                      filter((exclude != "1") & str_detect(drugname, "taxel"),
#                             str_detect(chemotherapy_type, "Adjuvant")) %>% 
#                      
#                      distinct(patientid, .keep_all = TRUE)), 
#            title = "OS from from first treatment all taxel", 
#            font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            
#            pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            # Add risk table
#            risk.table = "abs_pct", risk.table.title = "Risk table (number(%))",
#            risk.table.y.text = FALSE, risk.table.fontsize = 3, tables.height = 0.3,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(16, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(19, "bold", "black")
#            ),
#            
#            legend.title = "", xlab = "Time (in months)" 
# ) + guides(colour = guide_legend(ncol = 2))
```
</div>
</div>




<br>
<br>

***
# IV.Hazard Ratio

<span style="color:green">**Table 5 HR**</span>  
`coxph(Surv(time = month_at_os, event = vitalstatus)~variables`
```{r Table 5 HR}
# # tbl1 <- analysis_data %>% 
# #   select(bmi_cat) %>% 
# #   tbl_summary(#by = vitalstatus,
# #               statistic = all_categorical() ~ "{analysis_data %>% filter(vital == 'Dead') %>% NROW()} death ({n})"
# #               )
# # tbl2 <- coxph(Surv(time = month_at_os,
# #                      event = vitalstatus)~bmi_cat,
# #                 data = analysis_data) %>%
# #   tbl_regression(exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# # 
# # tbl_merge(list(tbl1, tbl2))
# # 
# # coxph(Surv(time = month_at_os, 
# #                      event = vitalstatus)~RDI_grp, 
# #                 data = analysis_data) %>% 
# #   tbl_uvregression(y = vitalstatus, exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# 
# analysis_data %>% select(vitalstatus, bmi, bmi_cat, raceeth) %>% 
# tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = analysis_data$month_at_os, event = analysis_data$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>% 
#   bold_labels() %>% italicize_levels() #%>%  modify_spanning_header(all_stat_cols() ~ "**Treatment Received**")
# 
# tbl1 <- analysis_data %>% 
#   filter(drugname == "carboplatin" & chemotherapy_type == "Neoadjuvant")
# tbl1 <- tbl1 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl1$month_at_os, event = tbl1$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# tbl2 <- analysis_data %>% 
#   filter(drugname == "carboplatin" & chemotherapy_type == "Adjuvant")
# tbl2 <- tbl2 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl2$month_at_os, event = tbl2$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# tbl3 <- analysis_data %>% 
#   filter(drugname == "carboplatin" & str_detect(chemotherapy_type, "Chemo"))
# tbl3 <- tbl3 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl3$month_at_os, event = tbl3$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# tbl_stack(list(tbl1, tbl2, tbl3),
#           group_header = c("carboplatin/Neoadjuvant", "carboplatin/Adjuvant", "carboplatin/Chemo only")) %>% 
#   bold_labels() %>%
#   italicize_levels()
# # Cisplatin
# tbl4 <- analysis_data %>% 
#   filter(str_detect(drugname,"cisplatin") & chemotherapy_type == "Neoadjuvant")
# tbl4 <- tbl4 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl4$month_at_os, event = tbl4$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# tbl5 <- analysis_data %>% 
#   filter(str_detect(drugname,"cisplatin") & chemotherapy_type == "Adjuvant")
# tbl5 <- tbl5 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl5$month_at_os, event = tbl5$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# tbl6 <- analysis_data %>% 
#   filter(str_detect(drugname,"cisplatin") & str_detect(chemotherapy_type, "Chemo"))
# tbl6 <- tbl6 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl6$month_at_os, event = tbl6$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# tbl_stack(list(tbl4, tbl5, tbl6),
#           group_header = c("cisplatin/Neoadjuvant", "cisplatin/Adjuvant", "cisplatin/Chemo only")) %>% 
#   bold_labels() %>%
#   italicize_levels()
# 
# 
# tbl7 <- analysis_data %>% 
#   filter(str_detect(drugname,"paclitaxel") & chemotherapy_type == "Neoadjuvant")
# tbl7 <- tbl7 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl7$month_at_os, event = tbl7$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# tbl8 <- analysis_data %>% 
#   filter(str_detect(drugname,"paclitaxel") & chemotherapy_type == "Adjuvant")
# tbl8 <- tbl8 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% 
#   tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl8$month_at_os, event = tbl8$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>% 
#   modify_header(update = list(label ~ "**paclitaxel/Adjuvant**"))
# tbl9 <- analysis_data %>% 
#   filter(str_detect(drugname,"paclitaxel") & str_detect(chemotherapy_type, "Chemo"))
# tbl9 <- tbl9 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl9$month_at_os, event = tbl9$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# tbl_stack(list(tbl7, tbl8, tbl9),
#           group_header = c("paclitaxel/Neoadjuvant", "paclitaxel/Adjuvant", "paclitaxel/Chemo only")) %>% 
#   bold_labels() %>%
#   italicize_levels()
# 
# tbl10 <- analysis_data %>% 
#   filter(str_detect(drugname, "taxel") & chemotherapy_type == "Neoadjuvant")
# tbl10 <- tbl10 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl10$month_at_os, event = tbl10$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# tbl11 <- analysis_data %>% 
#   filter(str_detect(drugname, "taxel") & chemotherapy_type == "Adjuvant")
# tbl11 <- tbl11 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% 
#   tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl11$month_at_os, event = tbl11$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent() %>% 
#   modify_header(update = list(label ~ "**paclitaxel/Adjuvant**"))
# tbl12 <- analysis_data %>% 
#   filter(str_detect(drugname,"taxel") & str_detect(chemotherapy_type, "Chemo"))
# tbl12 <- tbl12 %>% 
#   select(vitalstatus, RDI_grp, RDI_grp1) %>% tbl_uvregression(method = survival::coxph, 
#                  y = (Surv(time = tbl12$month_at_os, event = tbl12$vitalstatus)),
#                  exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent()
# tbl_stack(list(tbl10, tbl11, tbl12),
#           group_header = c("taxel/Neoadjuvant", "taxel/Adjuvant", "taxel/Chemo only")) %>% 
#   bold_labels() %>%
#   italicize_levels()
```
<br>
<br>

***
# V.Regression
## By clinical, demo
`glm(vitalstatus ~ bmi + bmi_cat + RDI_grp + raceeth, data = analysis_data, family = binomial)`
```{r}
# Regression vital status prediction
model <- glm(vitalstatus ~ bmi_at_dx + bmi_cat + #RDI_grp + 
               raceeth, data = analysis_data, family = binomial)
tbl1 <- tbl_regression(model) %>% bold_p(t = .05)
tbl2 <- tbl_regression(model) %>% bold_p(t = .05) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Estimate**", "**Exp**"))
```

`glm(vitalstatus ~ histology + tstage + brca1_tumor + brca2_tumor + issurgery + chemotherapy_type, data = analysis_data, family = binomial)`
```{r}
model <- glm(vitalstatus ~ 
               histology + tstage + brca1_tumor + brca2_tumor + 
             issurgery +
             chemotherapy_type, 
             data = analysis_data, family = binomial)
tbl1 <- tbl_regression(model) %>% bold_p(t = .05)
tbl2 <- tbl_regression(model) %>% bold_p(t = .05) %>% bold_p(t = .05)
tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Estimate**", "**Exp**"))
```

`glm(RDI_grp ~ agecat + bmi_cat + raceeth + stagecat + histology + chemotherapy_type, data = analysis_data, family = binomial)`
<!-- !!!! Prediction of RDI all drug together!!!! -->
```{r}
# Regression RDI prediction
# model <- glm(RDI_grp ~ agecat + bmi_cat + raceeth + stagecat + histology + chemotherapy_type, data = analysis_data, family = binomial)
# tbl1 <- tbl_regression(model) %>% bold_p(t = .05)
# tbl2 <- tbl_regression(model) %>% bold_p(t = .05) %>% bold_p(t = .05)
# tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Estimate**", "**Exp**"))
```

<!-- ### By drug -->
<!-- !!! But sometimes we had a switch between cisplatin/carboplatin -->
```{r}
# #  for carbo
# model <- glm(RDI_grp ~ agecat + raceeth + stagecat + histology + bmi_cat, data = analysis_data %>% 
#                filter(drugname == "carboplatin" & chemotherapy_type == "Adjuvant"), family = binomial)
# tbl1 <- tbl_regression(model) %>% bold_p(t = .05)
# tbl2 <- tbl_regression(model) %>% bold_p(t = .05) %>% bold_p(t = .05)
# tbl3 <- tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Estimate**", "**Exp**"))
# 
# model <- glm(RDI_grp ~ agecat + raceeth + stagecat + histology + bmi_cat, data = analysis_data %>% 
#                filter(drugname == "carboplatin" & chemotherapy_type == "Neoadjuvant"), family = binomial)
# tbl1 <- tbl_regression(model) %>% bold_p(t = .05)
# tbl2 <- tbl_regression(model) %>% bold_p(t = .05) %>% bold_p(t = .05)
# tbl4 <- tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Estimate**", "**Exp**"))
# 
# # tbl5 <- 
#   tbl_merge(list(tbl3, tbl4), tab_spanner = c("**carboplatin/Adjuvant**", "**carboplatin/Neoadjuvant**"))
#   
# #  for Cisplatim
# model <- glm(RDI_grp ~ agecat + raceeth + stagecat + histology + bmi_cat, data = analysis_data %>% 
#                filter(drugname == "cisplatin" & chemotherapy_type == "Adjuvant"), family = binomial)
# tbl1 <- tbl_regression(model) %>% bold_p(t = .05)
# tbl2 <- tbl_regression(model) %>% bold_p(t = .05) %>% bold_p(t = .05)
# tbl3 <- tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Estimate**", "**Exp**"))
# 
# model <- glm(RDI_grp ~ agecat + bmi_cat, data = analysis_data %>% 
#                filter(drugname == "cisplatin" & chemotherapy_type == "Neoadjuvant"), family = binomial)
# tbl1 <- tbl_regression(model) %>% bold_p(t = .05)
# tbl2 <- tbl_regression(model) %>% bold_p(t = .05) %>% bold_p(t = .05)
# tbl4 <- tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Estimate**", "**Exp**"))
# 
# # tbl5 <- 
#   tbl_merge(list(tbl3, tbl4), tab_spanner = c("**cisplatin/Adjuvant**", "**cisplatin/Neoadjuvant**"))
# 
# #  for taxel
# model <- glm(RDI_grp ~ agecat + raceeth + stagecat + histology + bmi_cat, data = analysis_data %>% 
#                filter(str_detect(drugname,"taxel") & (chemotherapy_type == "Adjuvant")), family = binomial)
# tbl1 <- tbl_regression(model) %>% bold_p(t = .05)
# tbl2 <- tbl_regression(model) %>% bold_p(t = .05) %>% bold_p(t = .05)
# tbl3 <- tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Estimate**", "**Exp**"))
# 
# model <- glm(RDI_grp ~ agecat + raceeth + stagecat + histology + bmi_cat, data = analysis_data %>% 
#                filter(str_detect(drugname,"taxel") & (chemotherapy_type == "Neoadjuvant")), family = binomial)
# tbl1 <- tbl_regression(model) %>% bold_p(t = .05)
# tbl2 <- tbl_regression(model) %>% bold_p(t = .05) %>% bold_p(t = .05)
# tbl4 <- tbl_merge(list(tbl1, tbl2), tab_spanner = c("**Estimate**", "**Exp**"))
# 
# # tbl6 <- 
#   tbl_merge(list(tbl4, tbl3), tab_spanner = c("**taxel/Adjuvant**", "**taxel/Neoadjuvant**"))
```
<br>
<br>

***



<!-- <div class = "row"> -->
<!-- <div class = "col-md-6"> -->
<!-- ```{r} -->

<!-- ``` -->
<!-- </div> -->

<!-- <div class = "col-md-6"> -->
<!-- ```{r} -->

<!-- ``` -->
<!-- </div> -->
<!-- </div> -->


<!-- ## Extra plots all line together -->

<!-- <div class = "row"> -->
<!-- <div class = "col-md-6"> -->
<!-- ```{r} -->
<!-- analysis_data %>% -->
<!--   filter(exclude != "1") %>%  -->
<!--   ggplot(aes(x= therapy))+ -->
<!--   geom_bar()+ -->
<!--   theme_minimal()+ -->
<!--   labs(title = "Frontline treatment")+ -->
<!--   coord_flip() -->

<!-- analysis_data %>% arrange(episodedate) %>% distinct(patientid, .keep_all = TRUE) %>%  -->
<!--   filter(exclude != "1") %>%  -->
<!--   group_by(chemotherapy_type) %>%  -->
<!--   summarize(count = n()) %>% mutate(percent=(count/sum(count)*100)) %>% -->
<!--   ggplot(aes(x= chemotherapy_type, y= percent, fill = chemotherapy_type))+ -->
<!--   geom_bar(stat="identity")+ -->
<!--   labs(x = "", title = "The first chemotherapy received by a patient Adjuvant for ~70% of the time") + -->
<!--   theme_minimal()+ -->
<!--   guides(fill = FALSE) + -->
<!--   coord_flip() -->
<!-- ``` -->
<!-- </div> -->

<!-- <div class = "col-md-6"> -->
<!-- ```{r} -->
<!-- analysis_data %>% arrange(episodedate) %>% distinct(patientid, .keep_all = TRUE) %>%  -->
<!--   filter(exclude != "1") %>%  -->
<!--   group_by(treatment_sequence) %>%  -->
<!--   summarize(count = n()) %>% mutate(percent=(count/sum(count)*100)) %>% -->
<!--   ggplot(aes(x= treatment_sequence, y= percent, fill = treatment_sequence))+ -->
<!--   geom_bar(stat="identity")+ -->
<!--   labs(x = "", title = "The treatment_sequence") + -->
<!--   theme_minimal()+ -->
<!--   guides(fill = FALSE) + -->
<!--   coord_flip() -->

<!-- # analysis_data %>% distinct(patientid, .keep_all = TRUE) %>%  -->
<!-- #   ggplot(aes(x= chemo))+ -->
<!-- #   geom_bar()+ -->
<!-- #   theme_minimal()+ -->
<!-- #   coord_flip() -->
<!-- ``` -->
<!-- </div> -->
<!-- </div> -->

<!-- <div class = "row"> -->
<!-- <div class = "col-md-6"> -->
<!-- ```{r} -->
<!-- # What are the RDI distribution for each type of chemo -->
<!-- print("A quick summary for the RDI repartition") -->
<!-- summary(analysis_data$mean_RDI_per_drug_chemotype) -->
<!-- Frontline %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>% -->
<!--   filter(exclude != "1") %>%  -->
<!--   ggplot(aes(x= chemotherapy_type, y= mean_RDI_per_drug_chemotype))+ -->
<!--   geom_boxplot()+ -->
<!--   geom_jitter(shape=16)+ -->
<!--   labs(x = "", title = "Warning 1 dot = RDI for 1 drugname per patient") + -->
<!--   theme_minimal() -->
<!-- ``` -->
<!-- </div> -->

<!-- <div class = "col-md-6"> -->
<!-- ```{r} -->
<!-- Frontline %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>% -->
<!--   filter(exclude != "1") %>%  -->
<!--   ggplot(aes(x= chemotherapy_type, y= mean_RDI_per_drug_chemotype))+ -->
<!--   # geom_boxplot()+ -->
<!--   ylim(c(-.5, 3.5))+ -->
<!--   geom_jitter(shape=16, aes(color=mean_RDI_per_drug_chemotype<0.85))+ -->
<!--   labs(x = "", title = "Warning 1 dot = RDI for 1 drugname per patient") + -->
<!--   theme_minimal() + -->
<!--   guides(color=FALSE) -->

<!-- Frontline %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>% -->
<!--   filter(exclude != "1") %>%  -->
<!--   ggplot(aes(x= chemotherapy_type, y= mean_RDI_per_drug_chemotype))+ -->
<!--   geom_violin()+ -->
<!--   ylim(c(-.5, 3.5))+ -->
<!--   # geom_jitter(shape=16, aes(color=mean_RDI_per_drug_chemotype<0.85))+ -->
<!--   theme_minimal() -->
<!-- ``` -->
<!-- </div> -->
<!-- </div> -->

<!-- <div class = "row"> -->
<!-- <div class = "col-md-6"> -->
<!-- ```{r} -->
<!-- # What are the RDI distribution for each drug -->
<!-- Frontline %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>% -->
<!--   filter(exclude != "1") %>%  -->
<!--   ggplot(aes(x= drugname, y= mean_RDI_per_drug_chemotype))+ -->
<!--   geom_violin(aes(color=mean_RDI_per_drug_chemotype<0.85))+ -->
<!--   ylim(c(-.5, 5.5))+ -->
<!--   # geom_jitter(shape=16, aes(color=mean_RDI_per_drug_chemotype<0.85))+ -->
<!--   theme_minimal()+ -->
<!--   coord_flip() -->

<!-- Frontline %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>% -->
<!--   filter(exclude != "1") %>%  -->
<!--   ggplot(aes(x= RDI_grp, fill = drugname))+ -->
<!--   geom_bar()+ -->
<!--   theme_minimal()+ -->
<!--   coord_flip() -->
<!-- ``` -->
<!-- </div> -->

<!-- <div class = "col-md-6"> -->
<!-- ```{r} -->
<!-- Frontline %>% filter(!is.na(mean_RDI_per_drug_chemotype)) %>% -->
<!--   filter(exclude != "1") %>%  -->
<!--   ggplot(aes(x= RDI_grp, fill = drugname))+ -->
<!--   geom_bar(position = "fill")+ -->
<!--   theme_minimal()+ -->
<!--   coord_flip() -->
<!-- ``` -->
<!-- </div> -->
<!-- </div> -->




